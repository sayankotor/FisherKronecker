2025-04-27 00:55:19,523 - INFO - Loading model: unsloth/llama-2-7b-chat
[2025-04-27 00:55:29,041] [INFO] [real_accelerator.py:222:get_accelerator] Setting ds_accelerator to cuda (auto detect)
nvcc warning : incompatible redefinition for option 'compiler-bindir', the last value of this option was used
nvcc warning : incompatible redefinition for option 'compiler-bindir', the last value of this option was used
nvcc warning : incompatible redefinition for option 'compiler-bindir', the last value of this option was used
nvcc warning : incompatible redefinition for option 'compiler-bindir', the last value of this option was used
nvcc warning : incompatible redefinition for option 'compiler-bindir', the last value of this option was used
nvcc warning : incompatible redefinition for option 'compiler-bindir', the last value of this option was used
nvcc warning : incompatible redefinition for option 'compiler-bindir', the last value of this option was used
Warning: The cache directory for DeepSpeed Triton autotune, /home/jovyan/.triton/autotune, appears to be on an NFS system. While this is generally acceptable, if you experience slowdowns or hanging when DeepSpeed exits, it is recommended to set the TRITON_CACHE_DIR environment variable to a non-NFS path.
Loading checkpoint shards:   0%|                                                                   | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████████▋                                       | 1/3 [00:01<00:03,  1.80s/it]Loading checkpoint shards:  67%|███████████████████████████████████████▎                   | 2/3 [00:05<00:02,  2.70s/it]Loading checkpoint shards: 100%|███████████████████████████████████████████████████████████| 3/3 [00:06<00:00,  1.91s/it]Loading checkpoint shards: 100%|███████████████████████████████████████████████████████████| 3/3 [00:06<00:00,  2.03s/it]
2025-04-27 00:55:37,133 - INFO - Model loaded with dtype torch.bfloat16
2025-04-27 00:56:35,323 - INFO - Model moved to cuda:3
2025-04-27 00:56:35,325 - INFO - Total parameters before compression: 6738415616
2025-04-27 00:56:35,326 - INFO - Layer: model.layers.21.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 00:56:35,327 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_self_attn_q_proj.safetensors
2025-04-27 00:56:35,327 - INFO - exists: True
2025-04-27 00:56:35,328 - INFO - factorize_layer_kron_svd
2025-04-27 00:56:36,532 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 00:56:37,785 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 00:56:39,041 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 00:56:40,155 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 00:56:41,456 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.21.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_self_attn_q_proj.safetensors True
Layer: model.layers.21.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [4.9928338e-03 1.8311075e-05 9.7191369e-06 7.7809100e-06 5.9942731e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 00:57:34,825 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 00:57:34,826 - INFO - Replacing 'model.layers.21.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 00:57:34,826 - INFO - Compression finished. 
2025-04-27 00:57:47,234 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                 | 0/21 [00:00<?, ?it/s]Evaluating:   0%|                                                                                 | 0/21 [00:08<?, ?it/s]
2025-04-27 00:58:03,466 - ERROR - Failed to evaluate on wikitext2: CUDA out of memory. Tried to allocate 500.00 MiB. GPU 2 has a total capacity of 79.25 GiB of which 367.62 MiB is free. Process 3587263 has 31.38 GiB memory in use. Process 3589855 has 32.51 GiB memory in use. Including non-PyTorch memory, this process has 14.99 GiB memory in use. Of the allocated memory 14.49 GiB is allocated by PyTorch, and 6.74 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
2025-04-27 00:58:03,466 - INFO - Evaluating on ptb
Evaluating:   0%|                                                                                  | 0/7 [00:00<?, ?it/s]Evaluating:   0%|                                                                                  | 0/7 [00:03<?, ?it/s]
2025-04-27 00:58:09,594 - ERROR - Failed to evaluate on ptb: CUDA out of memory. Tried to allocate 500.00 MiB. GPU 2 has a total capacity of 79.25 GiB of which 367.62 MiB is free. Process 3587263 has 31.38 GiB memory in use. Process 3589855 has 32.51 GiB memory in use. Including non-PyTorch memory, this process has 14.99 GiB memory in use. Of the allocated memory 14.49 GiB is allocated by PyTorch, and 6.74 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
2025-04-27 00:58:09,595 - INFO - Evaluation results:
2025-04-27 00:58:09,595 - INFO -   wikitext2: nan
2025-04-27 00:58:09,595 - INFO -   ptb: nan
Loading checkpoint shards:   0%|                                                                   | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████████▋                                       | 1/3 [00:02<00:04,  2.07s/it]Loading checkpoint shards:  67%|███████████████████████████████████████▎                   | 2/3 [00:04<00:02,  2.09s/it]Loading checkpoint shards: 100%|███████████████████████████████████████████████████████████| 3/3 [00:05<00:00,  1.89s/it]Loading checkpoint shards: 100%|███████████████████████████████████████████████████████████| 3/3 [00:05<00:00,  1.95s/it]
2025-04-27 00:58:16,083 - INFO - Layer: model.layers.21.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 00:58:16,085 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_self_attn_k_proj.safetensors
2025-04-27 00:58:16,085 - INFO - exists: True
2025-04-27 00:58:16,092 - INFO - factorize_layer_kron_svd
2025-04-27 00:58:17,473 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 00:58:18,931 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 00:58:20,570 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 00:58:21,772 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 00:58:23,241 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.21.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_self_attn_k_proj.safetensors True
Layer: model.layers.21.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.3128020e-03 9.2708731e-05 9.0614503e-06 4.9129476e-06 3.1025263e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 00:59:15,460 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 00:59:15,460 - INFO - Replacing 'model.layers.21.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 00:59:15,462 - INFO - Compression finished. 
Traceback (most recent call last):
  File "/home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/llama/llama_chat_select_layers.py", line 640, in <module>
    evaluation_results = evaluate_model(
                         ^^^^^^^^^^^^^^^
  File "/home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/llama/llama_chat_select_layers.py", line 512, in evaluate_model
    model.to(device)
  File "/home/jovyan/.mlspace/envs/vika_kurkin_clone/lib/python3.12/site-packages/transformers/modeling_utils.py", line 3698, in to
    return super().to(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jovyan/.mlspace/envs/vika_kurkin_clone/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1340, in to
    return self._apply(convert)
           ^^^^^^^^^^^^^^^^^^^^
  File "/home/jovyan/.mlspace/envs/vika_kurkin_clone/lib/python3.12/site-packages/torch/nn/modules/module.py", line 900, in _apply
    module._apply(fn)
  File "/home/jovyan/.mlspace/envs/vika_kurkin_clone/lib/python3.12/site-packages/torch/nn/modules/module.py", line 900, in _apply
    module._apply(fn)
  File "/home/jovyan/.mlspace/envs/vika_kurkin_clone/lib/python3.12/site-packages/torch/nn/modules/module.py", line 900, in _apply
    module._apply(fn)
  [Previous line repeated 2 more times]
  File "/home/jovyan/.mlspace/envs/vika_kurkin_clone/lib/python3.12/site-packages/torch/nn/modules/module.py", line 927, in _apply
    param_applied = fn(param)
                    ^^^^^^^^^
  File "/home/jovyan/.mlspace/envs/vika_kurkin_clone/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1326, in convert
    return t.to(
           ^^^^^
torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 86.00 MiB. GPU 2 has a total capacity of 79.25 GiB of which 45.62 MiB is free. Process 3587263 has 31.38 GiB memory in use. Process 3589855 has 32.51 GiB memory in use. Including non-PyTorch memory, this process has 15.30 GiB memory in use. Of the allocated memory 14.79 GiB is allocated by PyTorch, and 20.79 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         model.layers.13.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_13_mlp_down_proj.safetensors True
Layer: model.layers.13.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [6.3606212e-06 5.5213459e-06 5.4781272e-06 5.3353601e-06 5.1603465e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 00:55:36,550 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 00:55:36,550 - INFO - Replacing 'model.layers.13.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 00:55:36,557 - INFO - Compression finished. 
2025-04-27 00:55:43,945 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 00:56:15,479 - INFO - wikitext2 perplexity: 7.0938
2025-04-27 00:56:15,480 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9609375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.22s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.22s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.22s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.20s/it]
2025-04-27 00:56:25,493 - INFO - ptb perplexity: 26.2500
2025-04-27 00:56:25,494 - INFO - Evaluation results:
2025-04-27 00:56:25,494 - INFO -   wikitext2: 7.0938
2025-04-27 00:56:25,495 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:02<00:05,  2.92s/it]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:05<00:02,  2.43s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:06<00:00,  1.88s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:06<00:00,  2.08s/it]
2025-04-27 00:56:32,141 - INFO - Layer: model.layers.14.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 00:56:32,145 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_self_attn_q_proj.safetensors
2025-04-27 00:56:32,145 - INFO - exists: True
2025-04-27 00:56:32,169 - INFO - factorize_layer_kron_svd
2025-04-27 00:56:33,564 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 00:56:35,121 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 00:56:36,392 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 00:56:37,465 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 00:56:38,671 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 00:56:39,925 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.14.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_self_attn_q_proj.safetensors True
Layer: model.layers.14.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [3.3689321e-03 2.6556625e-04 1.9178900e-05 1.4112481e-05 1.0672710e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 00:57:36,463 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 00:57:36,463 - INFO - Replacing 'model.layers.14.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 00:57:36,465 - INFO - Compression finished. 
2025-04-27 00:57:41,176 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.23s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.22s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.22s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.22s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:17,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.22s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.22s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.24s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:16<00:15,  1.71s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:17<00:12,  1.57s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:18<00:10,  1.46s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:19<00:08,  1.41s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:22<00:09,  1.86s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:24<00:06,  1.69s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:25<00:04,  1.57s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:26<00:02,  1.46s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:27<00:01,  1.39s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:28<00:00,  1.26s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:28<00:00,  1.37s/it]
2025-04-27 00:58:15,025 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 00:58:15,025 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 00:58:25,413 - INFO - ptb perplexity: 25.7500
2025-04-27 00:58:25,413 - INFO - Evaluation results:
2025-04-27 00:58:25,413 - INFO -   wikitext2: 7.0000
2025-04-27 00:58:25,413 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:01<00:03,  1.91s/it]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:02<00:01,  1.35s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:06<00:00,  2.35s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:06<00:00,  2.13s/it]
2025-04-27 00:58:32,328 - INFO - Layer: model.layers.14.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 00:58:32,330 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_self_attn_k_proj.safetensors
2025-04-27 00:58:32,330 - INFO - exists: True
2025-04-27 00:58:32,340 - INFO - factorize_layer_kron_svd
2025-04-27 00:58:34,923 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 00:58:38,067 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 00:58:41,062 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 00:58:43,259 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 00:58:44,923 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 00:58:46,433 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.14.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_self_attn_k_proj.safetensors True
Layer: model.layers.14.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.9616026e-02 2.8029846e-05 1.7505350e-05 1.1700968e-05 9.4858715e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 00:59:31,348 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 00:59:31,349 - INFO - Replacing 'model.layers.14.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 00:59:31,351 - INFO - Compression finished. 
2025-04-27 00:59:35,555 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:02<00:55,  2.79s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:05<00:53,  2.79s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:08<00:50,  2.80s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:11<00:47,  2.78s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:13<00:44,  2.78s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:16<00:41,  2.79s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:19<00:39,  2.79s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:22<00:35,  2.71s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:23<00:28,  2.34s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:25<00:23,  2.17s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:28<00:23,  2.36s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:30<00:22,  2.49s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:33<00:20,  2.58s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:36<00:18,  2.65s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:38<00:15,  2.56s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:41<00:13,  2.63s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:44<00:10,  2.64s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:45<00:06,  2.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:46<00:03,  1.91s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:48<00:01,  1.70s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:48<00:00,  1.47s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:48<00:00,  2.33s/it]
2025-04-27 01:00:29,625 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:00:29,626 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:00:39,539 - INFO - ptb perplexity: 25.7500
2025-04-27 01:00:39,539 - INFO - Evaluation results:
2025-04-27 01:00:39,539 - INFO -   wikitext2: 7.0000
2025-04-27 01:00:39,539 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:01<00:02,  1.11s/it]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:02<00:01,  1.12s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:02<00:00,  1.07it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:02<00:00,  1.01it/s]
2025-04-27 01:00:42,854 - INFO - Layer: model.layers.14.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:00:42,855 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_self_attn_v_proj.safetensors
2025-04-27 01:00:42,855 - INFO - exists: True
2025-04-27 01:00:42,859 - INFO - factorize_layer_kron_svd
2025-04-27 01:00:43,975 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:00:45,395 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 01:00:46,501 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:00:47,668 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:00:49,082 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.14.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_self_attn_v_proj.safetensors True
Layer: model.layers.14.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.4001515e-03 4.1852738e-05 1.8041146e-05 1.1698585e-05 1.1010628e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:01:14,267 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:01:14,267 - INFO - Replacing 'model.layers.14.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 01:01:14,271 - INFO - Compression finished. 
2025-04-27 01:01:17,585 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:02<00:55,  2.78s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:05<00:52,  2.79s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:08<00:50,  2.79s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:10<00:42,  2.48s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:11<00:32,  2.02s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:13<00:32,  2.16s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:16<00:33,  2.37s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:19<00:32,  2.51s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:22<00:31,  2.60s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:25<00:29,  2.66s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:28<00:27,  2.70s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:30<00:24,  2.73s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:32<00:18,  2.37s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:33<00:14,  2.02s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:34<00:10,  1.78s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:36<00:08,  1.61s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:37<00:05,  1.49s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:38<00:04,  1.41s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:39<00:02,  1.35s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:40<00:01,  1.31s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:41<00:00,  1.20s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:41<00:00,  1.99s/it]
2025-04-27 01:02:04,393 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:02:04,393 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:02:14,493 - INFO - ptb perplexity: 25.7500
2025-04-27 01:02:14,494 - INFO - Evaluation results:
2025-04-27 01:02:14,494 - INFO -   wikitext2: 6.9375
2025-04-27 01:02:14,494 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:01<00:02,  1.33s/it]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:02<00:01,  1.33s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:03<00:00,  1.14s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:03<00:00,  1.19s/it]
2025-04-27 01:02:18,734 - INFO - Layer: model.layers.14.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:02:18,735 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_self_attn_o_proj.safetensors
2025-04-27 01:02:18,735 - INFO - exists: True
2025-04-27 01:02:18,740 - INFO - factorize_layer_kron_svd
2025-04-27 01:02:20,003 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:02:21,452 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:02:22,894 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:02:24,036 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:02:25,403 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:02:26,863 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.14.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_self_attn_o_proj.safetensors True
Layer: model.layers.14.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [6.2927091e-03 2.8666886e-05 1.8207767e-05 1.3825013e-05 1.3153526e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:02:53,475 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:02:53,475 - INFO - Replacing 'model.layers.14.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 01:02:53,477 - INFO - Compression finished. 
2025-04-27 01:02:55,949 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:02<00:55,  2.78s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:05<00:53,  2.79s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:08<00:50,  2.79s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:11<00:47,  2.79s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:13<00:44,  2.79s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:16<00:41,  2.79s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:19<00:39,  2.79s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:22<00:36,  2.79s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:25<00:33,  2.79s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:27<00:30,  2.79s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:30<00:27,  2.79s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:33<00:25,  2.79s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:34<00:18,  2.32s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:37<00:16,  2.33s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:39<00:14,  2.47s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:42<00:12,  2.57s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:45<00:10,  2.64s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:48<00:08,  2.68s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:51<00:05,  2.72s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:54<00:02,  2.82s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:55<00:00,  2.28s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:55<00:00,  2.63s/it]
2025-04-27 01:03:56,564 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:03:56,564 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:04:06,606 - INFO - ptb perplexity: 25.7500
2025-04-27 01:04:06,606 - INFO - Evaluation results:
2025-04-27 01:04:06,607 - INFO -   wikitext2: 6.9375
2025-04-27 01:04:06,607 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.19it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.10it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:02<00:00,  1.09it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:02<00:00,  1.10it/s]
2025-04-27 01:04:09,715 - INFO - Layer: model.layers.14.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:04:09,716 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_mlp_gate_proj.safetensors
2025-04-27 01:04:09,716 - INFO - exists: True
2025-04-27 01:04:09,722 - INFO - factorize_layer_kron_svd
2025-04-27 01:04:10,999 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:04:12,297 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:04:13,712 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:04:15,521 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:04:19,186 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.14.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_mlp_gate_proj.safetensors True
Layer: model.layers.14.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [3.2148813e-03 8.8560395e-05 2.4315630e-05 1.8305876e-05 1.6133905e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 01:05:17,486 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 01:05:17,487 - INFO - Replacing 'model.layers.14.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 01:05:17,492 - INFO - Compression finished. 
2025-04-27 01:05:21,844 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:05:51,839 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:05:51,839 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.22s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.22s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.22s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:06:01,838 - INFO - ptb perplexity: 25.7500
2025-04-27 01:06:01,838 - INFO - Evaluation results:
2025-04-27 01:06:01,838 - INFO -   wikitext2: 6.9375
2025-04-27 01:06:01,838 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.39it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.50it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.78it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.68it/s]
2025-04-27 01:06:03,982 - INFO - Layer: model.layers.14.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:06:03,983 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_mlp_up_proj.safetensors
2025-04-27 01:06:03,983 - INFO - exists: True
2025-04-27 01:06:03,998 - INFO - factorize_layer_kron_svd
2025-04-27 01:06:05,176 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:06:06,337 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:06:07,548 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:06:09,208 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:06:12,079 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:06:15,461 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.14.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_mlp_up_proj.safetensors True
Layer: model.layers.14.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [9.7202640e-03 2.5967920e-05 2.1275189e-05 1.6423986e-05 1.5875536e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 01:07:26,884 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 01:07:26,885 - INFO - Replacing 'model.layers.14.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 01:07:26,896 - INFO - Compression finished. 
2025-04-27 01:07:34,979 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.22s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.22s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.22s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:08:05,228 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:08:05,228 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:03<00:09,  1.80s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:06<00:09,  2.25s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:09<00:07,  2.46s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:11<00:05,  2.58s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:14<00:02,  2.64s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:17<00:00,  2.59s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:17<00:00,  2.43s/it]
2025-04-27 01:08:24,069 - INFO - ptb perplexity: 25.7500
2025-04-27 01:08:24,069 - INFO - Evaluation results:
2025-04-27 01:08:24,069 - INFO -   wikitext2: 6.9375
2025-04-27 01:08:24,070 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.49it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.49it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.67it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.62it/s]
2025-04-27 01:08:26,284 - INFO - Layer: model.layers.14.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:08:26,285 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_mlp_down_proj.safetensors
2025-04-27 01:08:26,285 - INFO - exists: True
2025-04-27 01:08:26,300 - INFO - factorize_layer_kron_svd
2025-04-27 01:08:27,987 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:08:29,786 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:08:31,553 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 01:08:33,345 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 01:08:35,144 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 01:08:38,486 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 01:08:39,498 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:08:40,542 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:08:41,577 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 01:08:42,627 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 01:08:43,702 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 01:08:44,913 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.14.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_14_mlp_down_proj.safetensors True
Layer: model.layers.14.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [6.0900875e-06 5.9317131e-06 5.6340173e-06 5.5387281e-06 5.4367842e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 01:10:16,860 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 01:10:16,861 - INFO - Replacing 'model.layers.14.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 01:10:16,867 - INFO - Compression finished. 
2025-04-27 01:10:20,084 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:10:51,280 - INFO - wikitext2 perplexity: 7.1562
2025-04-27 01:10:51,280 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.96875
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:11:01,216 - INFO - ptb perplexity: 26.2500
2025-04-27 01:11:01,216 - INFO - Evaluation results:
2025-04-27 01:11:01,216 - INFO -   wikitext2: 7.1562
2025-04-27 01:11:01,216 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.36it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.51it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.65it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.59it/s]
2025-04-27 01:11:03,655 - INFO - Layer: model.layers.15.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:11:03,656 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_self_attn_q_proj.safetensors
2025-04-27 01:11:03,656 - INFO - exists: True
2025-04-27 01:11:03,676 - INFO - factorize_layer_kron_svd
2025-04-27 01:11:04,738 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:11:05,971 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:11:07,208 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:11:08,251 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:11:09,369 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:11:10,601 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.15.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_self_attn_q_proj.safetensors True
Layer: model.layers.15.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.19919665e-02 7.38329763e-05 2.44418788e-05 1.36780509e-05
 1.00903217e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:11:36,565 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:11:36,565 - INFO - Replacing 'model.layers.15.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 01:11:36,567 - INFO - Compression finished. 
2025-04-27 01:11:39,591 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:12:09,946 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:12:09,946 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:12:20,371 - INFO - ptb perplexity: 25.7500
2025-04-27 01:12:20,372 - INFO - Evaluation results:
2025-04-27 01:12:20,372 - INFO -   wikitext2: 7.0000
2025-04-27 01:12:20,372 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.52it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.49it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.72it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.66it/s]
2025-04-27 01:12:22,631 - INFO - Layer: model.layers.15.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:12:22,635 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_self_attn_k_proj.safetensors
2025-04-27 01:12:22,635 - INFO - exists: True
2025-04-27 01:12:22,645 - INFO - factorize_layer_kron_svd
2025-04-27 01:12:23,744 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:12:24,901 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:12:26,102 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:12:27,164 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:12:28,310 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:12:29,526 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.15.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_self_attn_k_proj.safetensors True
Layer: model.layers.15.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [6.68922393e-03 1.50595792e-04 1.29176515e-05 1.03913790e-05
 8.53716847e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:12:50,058 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:12:50,058 - INFO - Replacing 'model.layers.15.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 01:12:50,061 - INFO - Compression finished. 
2025-04-27 01:12:52,101 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:13:22,229 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:13:22,229 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:13:32,333 - INFO - ptb perplexity: 25.7500
2025-04-27 01:13:32,333 - INFO - Evaluation results:
2025-04-27 01:13:32,333 - INFO -   wikitext2: 7.0000
2025-04-27 01:13:32,333 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.14it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.41it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.68it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.56it/s]
2025-04-27 01:13:34,717 - INFO - Layer: model.layers.15.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:13:34,722 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_self_attn_v_proj.safetensors
2025-04-27 01:13:34,722 - INFO - exists: True
2025-04-27 01:13:34,757 - INFO - factorize_layer_kron_svd
2025-04-27 01:13:35,902 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:13:37,135 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 01:13:38,277 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:13:39,480 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:13:40,694 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.15.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_self_attn_v_proj.safetensors True
Layer: model.layers.15.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [5.2174702e-03 3.7199647e-05 2.2397549e-05 1.4793896e-05 1.3787846e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:14:04,152 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:14:04,152 - INFO - Replacing 'model.layers.15.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 01:14:04,156 - INFO - Compression finished. 
2025-04-27 01:14:06,960 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:14:37,495 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:14:37,495 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:14:47,858 - INFO - ptb perplexity: 25.7500
2025-04-27 01:14:47,858 - INFO - Evaluation results:
2025-04-27 01:14:47,858 - INFO -   wikitext2: 6.9375
2025-04-27 01:14:47,858 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.64it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.69it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.95it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.87it/s]
2025-04-27 01:14:49,819 - INFO - Layer: model.layers.15.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:14:49,821 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_self_attn_o_proj.safetensors
2025-04-27 01:14:49,821 - INFO - exists: True
2025-04-27 01:14:49,825 - INFO - factorize_layer_kron_svd
2025-04-27 01:14:50,905 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:14:52,028 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:14:53,252 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:14:54,342 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:14:55,536 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:14:56,796 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.15.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_self_attn_o_proj.safetensors True
Layer: model.layers.15.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.3481039e-02 3.9970259e-05 2.5012072e-05 2.0769639e-05 1.6556156e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:15:17,467 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:15:17,467 - INFO - Replacing 'model.layers.15.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 01:15:17,471 - INFO - Compression finished. 
2025-04-27 01:15:19,492 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:15:50,062 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:15:50,062 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:16:00,174 - INFO - ptb perplexity: 25.7500
2025-04-27 01:16:00,175 - INFO - Evaluation results:
2025-04-27 01:16:00,175 - INFO -   wikitext2: 6.9375
2025-04-27 01:16:00,175 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.25it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.49it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.73it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.62it/s]
2025-04-27 01:16:02,391 - INFO - Layer: model.layers.15.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:16:02,393 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_mlp_gate_proj.safetensors
2025-04-27 01:16:02,393 - INFO - exists: True
2025-04-27 01:16:02,397 - INFO - factorize_layer_kron_svd
2025-04-27 01:16:03,612 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:16:04,824 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:16:06,078 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:16:07,763 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:16:11,386 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.15.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_mlp_gate_proj.safetensors True
Layer: model.layers.15.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [6.2121819e-03 2.8136490e-05 1.7869106e-05 1.6044041e-05 1.5440901e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 01:17:17,955 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 01:17:17,955 - INFO - Replacing 'model.layers.15.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 01:17:17,962 - INFO - Compression finished. 
2025-04-27 01:17:21,701 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:17:51,621 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 01:17:51,621 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:18:01,506 - INFO - ptb perplexity: 25.7500
2025-04-27 01:18:01,506 - INFO - Evaluation results:
2025-04-27 01:18:01,506 - INFO -   wikitext2: 7.0625
2025-04-27 01:18:01,506 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.48it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.60it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.83it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.74it/s]
2025-04-27 01:18:03,581 - INFO - Layer: model.layers.15.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:18:03,583 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_mlp_up_proj.safetensors
2025-04-27 01:18:03,583 - INFO - exists: True
2025-04-27 01:18:03,594 - INFO - factorize_layer_kron_svd
2025-04-27 01:18:04,773 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:18:05,926 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:18:07,188 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:18:08,843 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:18:11,995 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:18:15,679 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.15.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_mlp_up_proj.safetensors True
Layer: model.layers.15.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [5.9048464e-03 3.4873661e-05 1.9737899e-05 1.7797654e-05 1.4542696e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 01:19:18,700 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 01:19:18,701 - INFO - Replacing 'model.layers.15.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 01:19:18,707 - INFO - Compression finished. 
2025-04-27 01:19:28,567 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:19:58,791 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 01:19:58,792 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:20:08,733 - INFO - ptb perplexity: 25.7500
2025-04-27 01:20:08,734 - INFO - Evaluation results:
2025-04-27 01:20:08,734 - INFO -   wikitext2: 7.0625
2025-04-27 01:20:08,734 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.50it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.53it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.80it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.71it/s]
2025-04-27 01:20:11,173 - INFO - Layer: model.layers.15.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:20:11,175 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_mlp_down_proj.safetensors
2025-04-27 01:20:11,175 - INFO - exists: True
2025-04-27 01:20:11,199 - INFO - factorize_layer_kron_svd
2025-04-27 01:20:12,949 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:20:14,801 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:20:16,586 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 01:20:18,392 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 01:20:20,278 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 01:20:23,890 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 01:20:24,935 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:20:25,988 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:20:27,034 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 01:20:28,084 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 01:20:29,132 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 01:20:30,343 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.15.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_15_mlp_down_proj.safetensors True
Layer: model.layers.15.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [5.7206826e-06 5.4490124e-06 5.3648482e-06 5.2898772e-06 5.0597928e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 01:21:38,505 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 01:21:38,505 - INFO - Replacing 'model.layers.15.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 01:21:38,512 - INFO - Compression finished. 
2025-04-27 01:21:42,299 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:22:12,402 - INFO - wikitext2 perplexity: 7.0938
2025-04-27 01:22:12,402 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9609375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:22:22,366 - INFO - ptb perplexity: 26.2500
2025-04-27 01:22:22,366 - INFO - Evaluation results:
2025-04-27 01:22:22,366 - INFO -   wikitext2: 7.0938
2025-04-27 01:22:22,366 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.43it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.43it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.72it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.63it/s]
2025-04-27 01:22:24,605 - INFO - Layer: model.layers.16.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:22:24,607 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_self_attn_q_proj.safetensors
2025-04-27 01:22:24,607 - INFO - exists: True
2025-04-27 01:22:24,616 - INFO - factorize_layer_kron_svd
2025-04-27 01:22:25,733 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:22:26,899 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:22:28,116 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:22:29,171 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:22:30,304 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:22:31,535 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.16.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_self_attn_q_proj.safetensors True
Layer: model.layers.16.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.80752648e-02 2.68208059e-05 1.49044845e-05 1.20979112e-05
 1.04372784e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:22:52,937 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:22:52,937 - INFO - Replacing 'model.layers.16.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 01:22:52,940 - INFO - Compression finished. 
2025-04-27 01:22:54,868 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:23:25,433 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:23:25,434 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:23:35,539 - INFO - ptb perplexity: 25.7500
2025-04-27 01:23:35,539 - INFO - Evaluation results:
2025-04-27 01:23:35,540 - INFO -   wikitext2: 7.0000
2025-04-27 01:23:35,540 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.30it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.42it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.79it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.65it/s]
2025-04-27 01:23:37,713 - INFO - Layer: model.layers.16.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:23:37,719 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_self_attn_k_proj.safetensors
2025-04-27 01:23:37,719 - INFO - exists: True
2025-04-27 01:23:37,727 - INFO - factorize_layer_kron_svd
2025-04-27 01:23:38,800 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:23:39,971 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:23:41,167 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:23:42,217 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:23:43,406 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:23:44,605 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.16.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_self_attn_k_proj.safetensors True
Layer: model.layers.16.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.2368593e-02 2.3388826e-05 1.1153861e-05 9.9494391e-06 8.6804775e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:24:06,156 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:24:06,156 - INFO - Replacing 'model.layers.16.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 01:24:06,160 - INFO - Compression finished. 
2025-04-27 01:24:08,283 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:24:38,957 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:24:38,957 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:24:49,107 - INFO - ptb perplexity: 25.7500
2025-04-27 01:24:49,107 - INFO - Evaluation results:
2025-04-27 01:24:49,107 - INFO -   wikitext2: 7.0000
2025-04-27 01:24:49,107 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.11it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.30it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:02<00:00,  1.59it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:02<00:00,  1.47it/s]
2025-04-27 01:24:51,497 - INFO - Layer: model.layers.16.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:24:51,499 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_self_attn_v_proj.safetensors
2025-04-27 01:24:51,499 - INFO - exists: True
2025-04-27 01:24:51,505 - INFO - factorize_layer_kron_svd
2025-04-27 01:24:52,556 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:24:53,774 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 01:24:54,823 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:24:55,988 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:24:57,224 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.16.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_self_attn_v_proj.safetensors True
Layer: model.layers.16.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.1955712e-02 2.2352620e-05 1.8913308e-05 1.6113720e-05 1.5723988e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:25:24,465 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:25:24,465 - INFO - Replacing 'model.layers.16.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 01:25:24,467 - INFO - Compression finished. 
2025-04-27 01:25:26,498 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:25:57,017 - INFO - wikitext2 perplexity: 6.8750
2025-04-27 01:25:57,017 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9296875
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:26:06,920 - INFO - ptb perplexity: 25.3750
2025-04-27 01:26:06,920 - INFO - Evaluation results:
2025-04-27 01:26:06,920 - INFO -   wikitext2: 6.8750
2025-04-27 01:26:06,920 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.52it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.63it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.93it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.82it/s]
2025-04-27 01:26:08,926 - INFO - Layer: model.layers.16.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:26:08,928 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_self_attn_o_proj.safetensors
2025-04-27 01:26:08,928 - INFO - exists: True
2025-04-27 01:26:08,933 - INFO - factorize_layer_kron_svd
2025-04-27 01:26:09,999 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:26:11,243 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:26:12,493 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:26:13,575 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:26:14,796 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:26:16,081 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.16.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_self_attn_o_proj.safetensors True
Layer: model.layers.16.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.5437940e-02 3.6648642e-05 3.1384960e-05 2.5638148e-05 2.1998954e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:26:45,795 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:26:45,796 - INFO - Replacing 'model.layers.16.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 01:26:45,798 - INFO - Compression finished. 
2025-04-27 01:26:47,765 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:27:17,959 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:27:17,959 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:27:28,341 - INFO - ptb perplexity: 25.3750
2025-04-27 01:27:28,342 - INFO - Evaluation results:
2025-04-27 01:27:28,342 - INFO -   wikitext2: 6.9375
2025-04-27 01:27:28,342 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.50it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.54it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.91it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.79it/s]
2025-04-27 01:27:30,728 - INFO - Layer: model.layers.16.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:27:30,729 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_mlp_gate_proj.safetensors
2025-04-27 01:27:30,730 - INFO - exists: True
2025-04-27 01:27:30,736 - INFO - factorize_layer_kron_svd
2025-04-27 01:27:31,953 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:27:33,153 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:27:34,386 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:27:36,068 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:27:39,729 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.16.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_mlp_gate_proj.safetensors True
Layer: model.layers.16.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [3.0645484e-03 2.1843742e-05 8.2429324e-06 3.9983265e-06 3.0144206e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 01:28:38,865 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 01:28:38,865 - INFO - Replacing 'model.layers.16.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 01:28:38,873 - INFO - Compression finished. 
2025-04-27 01:28:40,807 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:29:11,780 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:29:11,780 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:29:22,208 - INFO - ptb perplexity: 25.7500
2025-04-27 01:29:22,209 - INFO - Evaluation results:
2025-04-27 01:29:22,209 - INFO -   wikitext2: 7.0000
2025-04-27 01:29:22,209 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.51it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.61it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.95it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.83it/s]
2025-04-27 01:29:24,203 - INFO - Layer: model.layers.16.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:29:24,204 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_mlp_up_proj.safetensors
2025-04-27 01:29:24,204 - INFO - exists: True
2025-04-27 01:29:24,224 - INFO - factorize_layer_kron_svd
2025-04-27 01:29:25,422 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:29:26,481 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:29:27,535 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 01:29:28,592 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 01:29:29,654 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 01:29:30,911 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 01:29:32,555 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:29:34,423 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:29:36,274 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 01:29:38,060 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 01:29:39,837 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 01:29:43,559 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.16.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_mlp_up_proj.safetensors True
Layer: model.layers.16.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [7.063774e-06 5.272135e-06 4.860023e-06 4.828677e-06 4.717410e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 01:30:51,952 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 01:30:51,952 - INFO - Replacing 'model.layers.16.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 01:30:51,962 - INFO - Compression finished. 
2025-04-27 01:30:55,117 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:31:25,149 - INFO - wikitext2 perplexity: 7.0938
2025-04-27 01:31:25,149 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9609375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:31:35,050 - INFO - ptb perplexity: 26.2500
2025-04-27 01:31:35,051 - INFO - Evaluation results:
2025-04-27 01:31:35,051 - INFO -   wikitext2: 7.0938
2025-04-27 01:31:35,051 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.58it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.50it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.77it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.70it/s]
2025-04-27 01:31:37,399 - INFO - Layer: model.layers.16.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:31:37,401 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_mlp_down_proj.safetensors
2025-04-27 01:31:37,401 - INFO - exists: True
2025-04-27 01:31:37,420 - INFO - factorize_layer_kron_svd
2025-04-27 01:31:39,171 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:31:42,368 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:31:46,104 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:31:47,174 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:31:48,370 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:31:49,662 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.16.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_16_mlp_down_proj.safetensors True
Layer: model.layers.16.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [5.7327412e-02 1.1083911e-04 5.4754466e-05 5.0081719e-05 4.2930162e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 01:32:59,993 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 01:32:59,994 - INFO - Replacing 'model.layers.16.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 01:33:00,001 - INFO - Compression finished. 
2025-04-27 01:33:02,094 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:33:32,233 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 01:33:32,233 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:33:42,188 - INFO - ptb perplexity: 26.2500
2025-04-27 01:33:42,188 - INFO - Evaluation results:
2025-04-27 01:33:42,188 - INFO -   wikitext2: 7.0625
2025-04-27 01:33:42,188 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:01<00:02,  1.18s/it]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:02<00:01,  1.12s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:03<00:00,  1.03it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:03<00:00,  1.02s/it]
2025-04-27 01:33:45,757 - INFO - Layer: model.layers.17.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:33:45,758 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_self_attn_q_proj.safetensors
2025-04-27 01:33:45,758 - INFO - exists: True
2025-04-27 01:33:45,770 - INFO - factorize_layer_kron_svd
2025-04-27 01:33:47,012 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:33:48,379 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:33:49,790 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:33:50,966 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:33:52,493 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:33:54,056 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.17.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_self_attn_q_proj.safetensors True
Layer: model.layers.17.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.9799747e-02 3.0997286e-05 1.8318075e-05 1.5734129e-05 9.7556685e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:34:22,572 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:34:22,572 - INFO - Replacing 'model.layers.17.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 01:34:22,575 - INFO - Compression finished. 
2025-04-27 01:34:24,421 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:34:54,433 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:34:54,433 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:35:04,606 - INFO - ptb perplexity: 25.7500
2025-04-27 01:35:04,606 - INFO - Evaluation results:
2025-04-27 01:35:04,607 - INFO -   wikitext2: 7.0000
2025-04-27 01:35:04,607 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.54it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.65it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.97it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.86it/s]
2025-04-27 01:35:07,101 - INFO - Layer: model.layers.17.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:35:07,103 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_self_attn_k_proj.safetensors
2025-04-27 01:35:07,103 - INFO - exists: True
2025-04-27 01:35:07,108 - INFO - factorize_layer_kron_svd
2025-04-27 01:35:08,221 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:35:09,495 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:35:10,814 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:35:11,881 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:35:13,054 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:35:14,371 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.17.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_self_attn_k_proj.safetensors True
Layer: model.layers.17.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.1035025e-02 2.1942167e-05 1.8688770e-05 1.1155682e-05 8.4285039e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:36:00,630 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:36:00,631 - INFO - Replacing 'model.layers.17.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 01:36:00,633 - INFO - Compression finished. 
2025-04-27 01:36:03,183 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:36:33,194 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:36:33,194 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:36:43,282 - INFO - ptb perplexity: 25.7500
2025-04-27 01:36:43,282 - INFO - Evaluation results:
2025-04-27 01:36:43,282 - INFO -   wikitext2: 7.0000
2025-04-27 01:36:43,282 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.59it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.51it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.77it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.70it/s]
2025-04-27 01:36:45,400 - INFO - Layer: model.layers.17.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:36:45,402 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_self_attn_v_proj.safetensors
2025-04-27 01:36:45,402 - INFO - exists: True
2025-04-27 01:36:45,407 - INFO - factorize_layer_kron_svd
2025-04-27 01:36:46,498 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:36:47,713 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 01:36:48,776 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:36:49,873 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:36:51,105 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.17.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_self_attn_v_proj.safetensors True
Layer: model.layers.17.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [4.8687169e-03 3.3752836e-05 1.3583940e-05 9.0827298e-06 8.3547020e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:37:34,434 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:37:34,434 - INFO - Replacing 'model.layers.17.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 01:37:34,440 - INFO - Compression finished. 
2025-04-27 01:37:36,974 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:38:07,276 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:38:07,277 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:38:17,284 - INFO - ptb perplexity: 25.7500
2025-04-27 01:38:17,284 - INFO - Evaluation results:
2025-04-27 01:38:17,284 - INFO -   wikitext2: 7.0000
2025-04-27 01:38:17,284 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.54it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.52it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.79it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.71it/s]
2025-04-27 01:38:19,399 - INFO - Layer: model.layers.17.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:38:19,401 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_self_attn_o_proj.safetensors
2025-04-27 01:38:19,401 - INFO - exists: True
2025-04-27 01:38:19,406 - INFO - factorize_layer_kron_svd
2025-04-27 01:38:20,507 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:38:21,679 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:38:22,910 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:38:24,010 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:38:25,239 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.17.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_self_attn_o_proj.safetensors True
Layer: model.layers.17.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [3.2809356e-03 2.6577334e-05 1.5983573e-05 1.3913510e-05 9.3074414e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:39:00,844 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:39:00,845 - INFO - Replacing 'model.layers.17.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 01:39:00,847 - INFO - Compression finished. 
2025-04-27 01:39:02,913 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.22s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.22s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.22s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.22s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.22s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:39:34,439 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:39:34,439 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:39:44,637 - INFO - ptb perplexity: 25.7500
2025-04-27 01:39:44,637 - INFO - Evaluation results:
2025-04-27 01:39:44,637 - INFO -   wikitext2: 7.0000
2025-04-27 01:39:44,637 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.46it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.52it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.89it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.76it/s]
2025-04-27 01:39:46,702 - INFO - Layer: model.layers.17.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:39:46,704 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_mlp_gate_proj.safetensors
2025-04-27 01:39:46,704 - INFO - exists: True
2025-04-27 01:39:46,713 - INFO - factorize_layer_kron_svd
2025-04-27 01:39:47,935 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:39:49,135 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:39:50,380 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:39:52,149 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:39:55,273 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.17.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_mlp_gate_proj.safetensors True
Layer: model.layers.17.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [1.2734500e-02 1.9533880e-05 1.8360362e-05 1.5285072e-05 1.4013754e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 01:40:54,126 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 01:40:54,126 - INFO - Replacing 'model.layers.17.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 01:40:54,141 - INFO - Compression finished. 
2025-04-27 01:40:56,831 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:41:27,000 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:41:27,001 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:41:37,182 - INFO - ptb perplexity: 25.7500
2025-04-27 01:41:37,182 - INFO - Evaluation results:
2025-04-27 01:41:37,182 - INFO -   wikitext2: 7.0000
2025-04-27 01:41:37,182 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:01<00:03,  1.79s/it]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:03<00:01,  1.80s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:04<00:00,  1.53s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:04<00:00,  1.60s/it]
2025-04-27 01:41:42,374 - INFO - Layer: model.layers.17.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:41:42,377 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_mlp_up_proj.safetensors
2025-04-27 01:41:42,377 - INFO - exists: True
2025-04-27 01:41:42,405 - INFO - factorize_layer_kron_svd
2025-04-27 01:41:44,152 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:41:45,518 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:41:47,057 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:41:48,895 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:41:52,647 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.17.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_mlp_up_proj.safetensors True
Layer: model.layers.17.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [5.35030011e-03 2.14593056e-05 1.69268369e-05 1.56144724e-05
 1.40765405e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 01:43:02,180 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 01:43:02,182 - INFO - Replacing 'model.layers.17.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 01:43:02,196 - INFO - Compression finished. 
2025-04-27 01:43:09,030 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:43:40,525 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 01:43:40,526 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.22s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.22s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.22s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.22s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.22s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.22s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.20s/it]
2025-04-27 01:43:51,479 - INFO - ptb perplexity: 25.7500
2025-04-27 01:43:51,479 - INFO - Evaluation results:
2025-04-27 01:43:51,479 - INFO -   wikitext2: 7.0625
2025-04-27 01:43:51,480 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.41it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.44it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.70it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.61it/s]
2025-04-27 01:43:53,720 - INFO - Layer: model.layers.17.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:43:53,722 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_mlp_down_proj.safetensors
2025-04-27 01:43:53,722 - INFO - exists: True
2025-04-27 01:43:53,733 - INFO - factorize_layer_kron_svd
2025-04-27 01:43:55,840 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:43:57,972 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:43:59,863 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 01:44:01,748 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 01:44:03,642 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 01:44:07,225 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 01:44:08,239 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:44:09,298 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:44:10,352 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 01:44:11,424 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 01:44:12,475 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 01:44:13,703 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.17.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_17_mlp_down_proj.safetensors True
Layer: model.layers.17.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [5.3840454e-06 4.7908156e-06 4.5387455e-06 4.4592825e-06 4.3278314e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 01:45:52,497 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 01:45:52,497 - INFO - Replacing 'model.layers.17.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 01:45:52,506 - INFO - Compression finished. 
2025-04-27 01:45:57,870 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:46:28,518 - INFO - wikitext2 perplexity: 7.1562
2025-04-27 01:46:28,518 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.96875
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:46:38,796 - INFO - ptb perplexity: 26.6250
2025-04-27 01:46:38,797 - INFO - Evaluation results:
2025-04-27 01:46:38,797 - INFO -   wikitext2: 7.1562
2025-04-27 01:46:38,797 - INFO -   ptb: 26.6250
nlls.shape torch.Size([16376])
Mean NLL: 3.28125
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.47it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.59it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.55it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.55it/s]
2025-04-27 01:46:41,083 - INFO - Layer: model.layers.18.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:46:41,084 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_self_attn_q_proj.safetensors
2025-04-27 01:46:41,084 - INFO - exists: True
2025-04-27 01:46:41,103 - INFO - factorize_layer_kron_svd
2025-04-27 01:46:42,189 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:46:43,451 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:46:44,833 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:46:46,015 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:46:47,322 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:46:48,886 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.18.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_self_attn_q_proj.safetensors True
Layer: model.layers.18.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [4.0405821e-03 8.4903695e-05 8.4368939e-06 7.6583383e-06 6.2006247e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:47:22,044 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:47:22,045 - INFO - Replacing 'model.layers.18.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 01:47:22,047 - INFO - Compression finished. 
2025-04-27 01:47:25,695 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:47:55,551 - INFO - wikitext2 perplexity: 6.8750
2025-04-27 01:47:55,551 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9296875
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:48:05,436 - INFO - ptb perplexity: 25.3750
2025-04-27 01:48:05,436 - INFO - Evaluation results:
2025-04-27 01:48:05,436 - INFO -   wikitext2: 6.8750
2025-04-27 01:48:05,436 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.28it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.42it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.75it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.63it/s]
2025-04-27 01:48:07,647 - INFO - Layer: model.layers.18.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:48:07,648 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_self_attn_k_proj.safetensors
2025-04-27 01:48:07,648 - INFO - exists: True
2025-04-27 01:48:07,655 - INFO - factorize_layer_kron_svd
2025-04-27 01:48:08,795 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:48:09,973 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:48:11,231 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:48:12,310 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:48:13,534 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:48:14,843 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.18.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_self_attn_k_proj.safetensors True
Layer: model.layers.18.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [7.7125463e-03 3.3378132e-05 8.2256274e-06 7.4304949e-06 6.1785499e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:48:57,257 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:48:57,257 - INFO - Replacing 'model.layers.18.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 01:48:57,259 - INFO - Compression finished. 
2025-04-27 01:49:00,490 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:49:30,462 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:49:30,463 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:49:40,675 - INFO - ptb perplexity: 25.7500
2025-04-27 01:49:40,675 - INFO - Evaluation results:
2025-04-27 01:49:40,675 - INFO -   wikitext2: 6.9375
2025-04-27 01:49:40,675 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.52it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.53it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.77it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.70it/s]
2025-04-27 01:49:42,814 - INFO - Layer: model.layers.18.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:49:42,815 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_self_attn_v_proj.safetensors
2025-04-27 01:49:42,815 - INFO - exists: True
2025-04-27 01:49:42,823 - INFO - factorize_layer_kron_svd
2025-04-27 01:49:44,445 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:49:45,804 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 01:49:46,857 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:49:48,043 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:49:49,288 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.18.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_self_attn_v_proj.safetensors True
Layer: model.layers.18.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [4.0681469e-03 1.6707516e-05 1.2347067e-05 1.0038388e-05 9.6414569e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:50:29,754 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:50:29,755 - INFO - Replacing 'model.layers.18.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 01:50:29,758 - INFO - Compression finished. 
2025-04-27 01:50:32,380 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:51:03,340 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:51:03,340 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:51:13,472 - INFO - ptb perplexity: 25.3750
2025-04-27 01:51:13,472 - INFO - Evaluation results:
2025-04-27 01:51:13,473 - INFO -   wikitext2: 6.9375
2025-04-27 01:51:13,473 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.48it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.58it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.81it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.73it/s]
2025-04-27 01:51:15,630 - INFO - Layer: model.layers.18.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:51:15,631 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_self_attn_o_proj.safetensors
2025-04-27 01:51:15,631 - INFO - exists: True
2025-04-27 01:51:15,638 - INFO - factorize_layer_kron_svd
2025-04-27 01:51:16,725 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:51:18,019 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:51:19,289 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:51:21,094 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:51:22,353 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.18.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_self_attn_o_proj.safetensors True
Layer: model.layers.18.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [6.4145559e-03 1.3282548e-05 1.1804969e-05 1.0802285e-05 9.4289271e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:51:59,560 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:51:59,560 - INFO - Replacing 'model.layers.18.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 01:51:59,563 - INFO - Compression finished. 
2025-04-27 01:52:02,975 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.22s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.22s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:17<00:08,  1.22s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.22s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:52:34,672 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:52:34,672 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:52:44,744 - INFO - ptb perplexity: 25.3750
2025-04-27 01:52:44,744 - INFO - Evaluation results:
2025-04-27 01:52:44,744 - INFO -   wikitext2: 6.9375
2025-04-27 01:52:44,744 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.47it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.48it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.74it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.66it/s]
2025-04-27 01:52:46,901 - INFO - Layer: model.layers.18.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:52:46,904 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_mlp_gate_proj.safetensors
2025-04-27 01:52:46,904 - INFO - exists: True
2025-04-27 01:52:46,909 - INFO - factorize_layer_kron_svd
2025-04-27 01:52:48,134 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:52:49,362 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:52:50,602 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:52:52,413 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:52:56,090 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.18.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_mlp_gate_proj.safetensors True
Layer: model.layers.18.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [8.0129793e-03 1.8024977e-05 1.6487887e-05 1.3588725e-05 1.1236772e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 01:54:21,529 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 01:54:21,530 - INFO - Replacing 'model.layers.18.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 01:54:21,535 - INFO - Compression finished. 
2025-04-27 01:54:23,517 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:17,  1.22s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:54:54,259 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:54:54,259 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:55:04,188 - INFO - ptb perplexity: 25.7500
2025-04-27 01:55:04,189 - INFO - Evaluation results:
2025-04-27 01:55:04,189 - INFO -   wikitext2: 7.0000
2025-04-27 01:55:04,189 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.62it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.67it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.89it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.81it/s]
2025-04-27 01:55:06,283 - INFO - Layer: model.layers.18.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:55:06,285 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_mlp_up_proj.safetensors
2025-04-27 01:55:06,285 - INFO - exists: True
2025-04-27 01:55:06,298 - INFO - factorize_layer_kron_svd
2025-04-27 01:55:07,460 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:55:08,587 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:55:09,791 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:55:11,511 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:55:14,751 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.18.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_mlp_up_proj.safetensors True
Layer: model.layers.18.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [5.7937209e-03 2.0253658e-05 1.6411330e-05 1.4584949e-05 1.2499403e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 01:56:44,100 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 01:56:44,101 - INFO - Replacing 'model.layers.18.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 01:56:44,125 - INFO - Compression finished. 
2025-04-27 01:56:46,573 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.22s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.22s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.22s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.22s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.22s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:57:17,153 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 01:57:17,154 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:57:27,026 - INFO - ptb perplexity: 25.7500
2025-04-27 01:57:27,026 - INFO - Evaluation results:
2025-04-27 01:57:27,026 - INFO -   wikitext2: 7.0625
2025-04-27 01:57:27,026 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.45it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.48it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.75it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.66it/s]
2025-04-27 01:57:29,185 - INFO - Layer: model.layers.18.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:57:29,217 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_mlp_down_proj.safetensors
2025-04-27 01:57:29,217 - INFO - exists: True
2025-04-27 01:57:29,229 - INFO - factorize_layer_kron_svd
2025-04-27 01:57:30,951 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:57:32,785 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:57:34,601 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 01:57:36,386 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 01:57:38,162 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 01:57:41,015 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 01:57:42,015 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:57:43,075 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:57:44,120 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 01:57:45,143 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 01:57:46,170 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 01:57:47,312 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.18.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_18_mlp_down_proj.safetensors True
Layer: model.layers.18.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [5.3391209e-06 4.7852341e-06 4.6904747e-06 4.5298430e-06 4.3949844e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 01:59:13,681 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 01:59:13,682 - INFO - Replacing 'model.layers.18.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 01:59:13,690 - INFO - Compression finished. 
2025-04-27 01:59:15,663 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 01:59:46,274 - INFO - wikitext2 perplexity: 7.1562
2025-04-27 01:59:46,274 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.96875
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 01:59:56,348 - INFO - ptb perplexity: 26.2500
2025-04-27 01:59:56,348 - INFO - Evaluation results:
2025-04-27 01:59:56,348 - INFO -   wikitext2: 7.1562
2025-04-27 01:59:56,348 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.52it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.51it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.82it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.72it/s]
2025-04-27 01:59:58,437 - INFO - Layer: model.layers.19.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:59:58,438 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_self_attn_q_proj.safetensors
2025-04-27 01:59:58,438 - INFO - exists: True
2025-04-27 01:59:58,460 - INFO - factorize_layer_kron_svd
2025-04-27 01:59:59,781 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:00:01,078 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 02:00:02,174 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:00:03,474 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.19.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_self_attn_q_proj.safetensors True
Layer: model.layers.19.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.2634035e-03 7.5883843e-05 1.0972199e-05 7.9327338e-06 7.6394726e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:00:48,651 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:00:48,651 - INFO - Replacing 'model.layers.19.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 02:00:48,654 - INFO - Compression finished. 
2025-04-27 02:00:50,585 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 02:01:21,103 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 02:01:21,103 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 02:01:31,318 - INFO - ptb perplexity: 25.7500
2025-04-27 02:01:31,318 - INFO - Evaluation results:
2025-04-27 02:01:31,319 - INFO -   wikitext2: 7.0000
2025-04-27 02:01:31,319 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.44it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.50it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.87it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.74it/s]
2025-04-27 02:01:33,403 - INFO - Layer: model.layers.19.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:01:33,405 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_self_attn_k_proj.safetensors
2025-04-27 02:01:33,405 - INFO - exists: True
2025-04-27 02:01:33,413 - INFO - factorize_layer_kron_svd
2025-04-27 02:01:34,481 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:01:35,519 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:01:36,741 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 02:01:38,243 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 02:01:39,334 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 02:01:40,528 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 02:01:41,579 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:01:42,646 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:01:43,719 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 02:01:44,809 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 02:01:45,888 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 02:01:47,108 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.19.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_self_attn_k_proj.safetensors True
Layer: model.layers.19.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.4139777e-05 7.3872861e-06 6.7703445e-06 6.6463708e-06 6.5448608e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:02:32,825 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:02:32,825 - INFO - Replacing 'model.layers.19.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 02:02:32,827 - INFO - Compression finished. 
2025-04-27 02:02:36,420 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 02:03:07,353 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 02:03:07,353 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 02:03:17,290 - INFO - ptb perplexity: 25.7500
2025-04-27 02:03:17,290 - INFO - Evaluation results:
2025-04-27 02:03:17,290 - INFO -   wikitext2: 7.0000
2025-04-27 02:03:17,291 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.52it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.49it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.75it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.67it/s]
2025-04-27 02:03:19,892 - INFO - Layer: model.layers.19.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:03:19,893 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_self_attn_v_proj.safetensors
2025-04-27 02:03:19,893 - INFO - exists: True
2025-04-27 02:03:19,903 - INFO - factorize_layer_kron_svd
2025-04-27 02:03:21,442 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:03:22,917 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 02:03:23,998 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:03:25,153 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:03:26,336 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.19.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_self_attn_v_proj.safetensors True
Layer: model.layers.19.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.99678487e-03 1.78204009e-05 1.02312115e-05 8.12599683e-06
 7.39516963e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:03:56,048 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:03:56,048 - INFO - Replacing 'model.layers.19.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 02:03:56,052 - INFO - Compression finished. 
2025-04-27 02:03:58,798 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 02:04:28,949 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 02:04:28,949 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 02:04:39,104 - INFO - ptb perplexity: 25.7500
2025-04-27 02:04:39,104 - INFO - Evaluation results:
2025-04-27 02:04:39,104 - INFO -   wikitext2: 7.0000
2025-04-27 02:04:39,104 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.39it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.48it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.85it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.72it/s]
2025-04-27 02:04:41,224 - INFO - Layer: model.layers.19.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:04:41,226 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_self_attn_o_proj.safetensors
2025-04-27 02:04:41,226 - INFO - exists: True
2025-04-27 02:04:41,231 - INFO - factorize_layer_kron_svd
2025-04-27 02:04:42,316 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:04:43,484 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 02:04:44,558 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:04:45,708 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.19.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_self_attn_o_proj.safetensors True
Layer: model.layers.19.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [5.1457360e-03 1.0752487e-05 1.0072938e-05 8.8459146e-06 7.3614151e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:05:07,769 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:05:07,769 - INFO - Replacing 'model.layers.19.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 02:05:07,772 - INFO - Compression finished. 
2025-04-27 02:05:09,685 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 02:05:39,966 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 02:05:39,966 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 02:05:50,150 - INFO - ptb perplexity: 25.7500
2025-04-27 02:05:50,150 - INFO - Evaluation results:
2025-04-27 02:05:50,150 - INFO -   wikitext2: 7.0000
2025-04-27 02:05:50,150 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:01<00:02,  1.17s/it]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:02<00:01,  1.12s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:02<00:00,  1.19it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:02<00:00,  1.08it/s]
2025-04-27 02:05:53,280 - INFO - Layer: model.layers.19.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 02:05:53,282 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_mlp_gate_proj.safetensors
2025-04-27 02:05:53,282 - INFO - exists: True
2025-04-27 02:05:53,291 - INFO - factorize_layer_kron_svd
2025-04-27 02:05:54,642 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:05:55,834 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:05:57,080 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:05:58,892 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:06:01,968 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.19.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_mlp_gate_proj.safetensors True
Layer: model.layers.19.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [6.8501011e-03 1.8891638e-05 1.4157393e-05 1.3611631e-05 1.2496623e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 02:06:55,862 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 02:06:55,863 - INFO - Replacing 'model.layers.19.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 02:06:55,869 - INFO - Compression finished. 
2025-04-27 02:06:57,725 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 02:07:27,588 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 02:07:27,588 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 02:07:37,551 - INFO - ptb perplexity: 25.7500
2025-04-27 02:07:37,551 - INFO - Evaluation results:
2025-04-27 02:07:37,551 - INFO -   wikitext2: 7.0000
2025-04-27 02:07:37,551 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:01<00:02,  1.32s/it]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:02<00:01,  1.28s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:03<00:00,  1.04s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:03<00:00,  1.11s/it]
2025-04-27 02:07:41,281 - INFO - Layer: model.layers.19.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 02:07:41,282 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_mlp_up_proj.safetensors
2025-04-27 02:07:41,282 - INFO - exists: True
2025-04-27 02:07:41,299 - INFO - factorize_layer_kron_svd
2025-04-27 02:07:42,534 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:07:44,219 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:07:45,560 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:07:47,896 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:07:54,705 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.19.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_mlp_up_proj.safetensors True
Layer: model.layers.19.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [5.9256121e-03 1.7187345e-05 1.4408997e-05 1.2730728e-05 9.7351012e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 02:09:01,134 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 02:09:01,134 - INFO - Replacing 'model.layers.19.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 02:09:01,141 - INFO - Compression finished. 
2025-04-27 02:09:02,861 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 02:09:32,947 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 02:09:32,947 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 02:09:42,849 - INFO - ptb perplexity: 25.7500
2025-04-27 02:09:42,850 - INFO - Evaluation results:
2025-04-27 02:09:42,850 - INFO -   wikitext2: 7.0625
2025-04-27 02:09:42,850 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:01<00:03,  1.51s/it]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:03<00:01,  1.52s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:04<00:00,  1.28s/it]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:04<00:00,  1.35s/it]
2025-04-27 02:09:47,266 - INFO - Layer: model.layers.19.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 02:09:47,268 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_mlp_down_proj.safetensors
2025-04-27 02:09:47,268 - INFO - exists: True
2025-04-27 02:09:47,315 - INFO - factorize_layer_kron_svd
2025-04-27 02:09:49,438 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:09:52,644 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:09:56,446 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:09:57,550 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:09:58,710 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:09:59,932 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.19.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_19_mlp_down_proj.safetensors True
Layer: model.layers.19.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [3.5986744e-02 9.2276161e-05 4.2714488e-05 3.8102378e-05 3.5181394e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 02:11:09,811 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 02:11:09,811 - INFO - Replacing 'model.layers.19.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 02:11:09,816 - INFO - Compression finished. 
2025-04-27 02:11:13,072 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                   | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▊                                                        | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▌                                                     | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▍                                                  | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▏                                               | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████                                             | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|████████████████▊                                          | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████▋                                       | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|██████████████████████▍                                    | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|█████████████████████████▎                                 | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|███████████████████████████▌                              | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|██████████████████████████████▍                           | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████▏                        | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|███████████████████████████████████▉                      | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████▋                   | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████▍                | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|████████████████████████████████████████████▏             | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|██████████████████████████████████████████████▉           | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████▋        | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████▍     | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|███████████████████████████████████████████████████████▏  | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|██████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-27 02:11:44,111 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 02:11:44,112 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                    | 0/7 [00:00<?, ?it/s]Evaluating:  14%|████████▌                                                   | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|█████████████████▏                                          | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|█████████████████████████▋                                  | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████▎                         | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████▊                 | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████▍        | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 02:11:54,136 - INFO - ptb perplexity: 25.7500
2025-04-27 02:11:54,137 - INFO - Evaluation results:
2025-04-27 02:11:54,137 - INFO -   wikitext2: 7.0625
2025-04-27 02:11:54,137 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                     | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███████████████                              | 1/3 [00:00<00:01,  1.42it/s]Loading checkpoint shards:  67%|██████████████████████████████               | 2/3 [00:01<00:00,  1.55it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.93it/s]Loading checkpoint shards: 100%|█████████████████████████████████████████████| 3/3 [00:01<00:00,  1.79it/s]



dct
{'model.layers.11.self_attn.q_proj': [6.9375, 25.75], 'model.layers.11.self_attn.k_proj': [nan, nan], 'model.layers.11.self_attn.v_proj': [nan, nan], 'model.layers.11.self_attn.o_proj': [6.9375, 25.75], 'model.layers.11.mlp.gate_proj': [7.0, 25.375], 'model.layers.11.mlp.up_proj': [7.0625, 25.75], 'model.layers.11.mlp.down_proj': [7.09375, 26.25], 'model.layers.12.self_attn.q_proj': [6.9375, 25.75], 'model.layers.12.self_attn.k_proj': [6.9375, 25.375], 'model.layers.12.self_attn.v_proj': [6.9375, 25.75], 'model.layers.12.self_attn.o_proj': [6.9375, 26.25], 'model.layers.12.mlp.gate_proj': [7.0, 25.75], 'model.layers.12.mlp.up_proj': [6.9375, 25.75], 'model.layers.12.mlp.down_proj': [7.09375, 26.25], 'model.layers.13.self_attn.q_proj': [6.9375, 25.75], 'model.layers.13.self_attn.k_proj': [6.9375, 25.75], 'model.layers.13.self_attn.v_proj': [6.875, 25.75], 'model.layers.13.self_attn.o_proj': [6.875, 25.75], 'model.layers.13.mlp.gate_proj': [7.0, 25.75], 'model.layers.13.mlp.up_proj': [7.0, 26.25], 'model.layers.13.mlp.down_proj': [7.09375, 26.25], 'model.layers.14.self_attn.q_proj': [7.0, 25.75], 'model.layers.14.self_attn.k_proj': [7.0, 25.75], 'model.layers.14.self_attn.v_proj': [6.9375, 25.75], 'model.layers.14.self_attn.o_proj': [6.9375, 25.75], 'model.layers.14.mlp.gate_proj': [6.9375, 25.75], 'model.layers.14.mlp.up_proj': [6.9375, 25.75], 'model.layers.14.mlp.down_proj': [7.15625, 26.25], 'model.layers.15.self_attn.q_proj': [7.0, 25.75], 'model.layers.15.self_attn.k_proj': [7.0, 25.75], 'model.layers.15.self_attn.v_proj': [6.9375, 25.75], 'model.layers.15.self_attn.o_proj': [6.9375, 25.75], 'model.layers.15.mlp.gate_proj': [7.0625, 25.75], 'model.layers.15.mlp.up_proj': [7.0625, 25.75], 'model.layers.15.mlp.down_proj': [7.09375, 26.25], 'model.layers.16.self_attn.q_proj': [7.0, 25.75], 'model.layers.16.self_attn.k_proj': [7.0, 25.75], 'model.layers.16.self_attn.v_proj': [6.875, 25.375], 'model.layers.16.self_attn.o_proj': [6.9375, 25.375], 'model.layers.16.mlp.gate_proj': [7.0, 25.75], 'model.layers.16.mlp.up_proj': [7.09375, 26.25], 'model.layers.16.mlp.down_proj': [7.0625, 26.25], 'model.layers.17.self_attn.q_proj': [7.0, 25.75], 'model.layers.17.self_attn.k_proj': [7.0, 25.75], 'model.layers.17.self_attn.v_proj': [7.0, 25.75], 'model.layers.17.self_attn.o_proj': [7.0, 25.75], 'model.layers.17.mlp.gate_proj': [7.0, 25.75], 'model.layers.17.mlp.up_proj': [7.0625, 25.75], 'model.layers.17.mlp.down_proj': [7.15625, 26.625], 'model.layers.18.self_attn.q_proj': [6.875, 25.375], 'model.layers.18.self_attn.k_proj': [6.9375, 25.75], 'model.layers.18.self_attn.v_proj': [6.9375, 25.375], 'model.layers.18.self_attn.o_proj': [6.9375, 25.375], 'model.layers.18.mlp.gate_proj': [7.0, 25.75], 'model.layers.18.mlp.up_proj': [7.0625, 25.75], 'model.layers.18.mlp.down_proj': [7.15625, 26.25], 'model.layers.19.self_attn.q_proj': [7.0, 25.75], 'model.layers.19.self_attn.k_proj': [7.0, 25.75], 'model.layers.19.self_attn.v_proj': [7.0, 25.75], 'model.layers.19.self_attn.o_proj': [7.0, 25.75], 'model.layers.19.mlp.gate_proj': [7.0, 25.75], 'model.layers.19.mlp.up_proj': [7.0625, 25.75], 'model.layers.19.mlp.down_proj': [7.0625, 25.75]}
