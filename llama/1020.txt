2025-04-28 00:03:58,726 - INFO - Loading model: unsloth/llama-2-7b-chat
[2025-04-28 00:04:03,663] [INFO] [real_accelerator.py:222:get_accelerator] Setting ds_accelerator to cuda (auto detect)
Warning: The cache directory for DeepSpeed Triton autotune, /home/jovyan/.triton/autotune, appears to be on an NFS system. While this is generally acceptable, if you experience slowdowns or hanging when DeepSpeed exits, it is recommended to set the TRITON_CACHE_DIR environment variable to a non-NFS path.
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.59it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.65it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  2.03it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.90it/s]
2025-04-28 00:04:07,233 - INFO - Model loaded with dtype torch.bfloat16
2025-04-28 00:04:37,855 - INFO - Model moved to cuda:0
2025-04-28 00:04:37,856 - INFO - Total parameters before compression: 6738415616
2025-04-28 00:04:37,857 - INFO - Layer: model.layers.10.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-28 00:04:37,858 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_self_attn_q_proj.safetensors
2025-04-28 00:04:37,858 - INFO - exists: True
2025-04-28 00:04:37,870 - INFO - factorize_layer_kron_svd
2025-04-28 00:04:39,165 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:04:40,377 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:04:41,616 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-28 00:04:42,714 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:04:43,925 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:04:45,213 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.10.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_self_attn_q_proj.safetensors True
Layer: model.layers.10.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [5.9142308e-03 7.8129844e-05 2.2622453e-05 1.3935448e-05 1.1394095e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-28 00:05:07,211 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-28 00:05:07,211 - INFO - Replacing 'model.layers.10.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-28 00:05:07,211 - INFO - Compression finished. 
2025-04-28 00:05:07,214 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:04<01:29,  4.46s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:05<00:48,  2.55s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:06<00:34,  1.94s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:08<00:28,  1.65s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:09<00:23,  1.49s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:10<00:20,  1.40s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:11<00:18,  1.34s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:12<00:16,  1.30s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:14<00:15,  1.27s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:15<00:13,  1.25s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:16<00:12,  1.24s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:17<00:11,  1.23s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:19<00:09,  1.23s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:20<00:08,  1.22s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:21<00:07,  1.22s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:22<00:06,  1.22s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:23<00:04,  1.22s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:25<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:26<00:02,  1.26s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:27<00:01,  1.25s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:28<00:00,  1.15s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:28<00:00,  1.36s/it]
2025-04-28 00:05:43,063 - INFO - wikitext2 perplexity: 6.9375
2025-04-28 00:05:43,063 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:05:53,625 - INFO - ptb perplexity: 25.7500
2025-04-28 00:05:53,625 - INFO - Evaluation results:
2025-04-28 00:05:53,625 - INFO -   wikitext2: 6.9375
2025-04-28 00:05:53,625 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.47it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.46it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.74it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.65it/s]
2025-04-28 00:05:56,196 - INFO - Layer: model.layers.10.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-28 00:05:56,198 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_self_attn_k_proj.safetensors
2025-04-28 00:05:56,198 - INFO - exists: True
2025-04-28 00:05:56,221 - INFO - factorize_layer_kron_svd
2025-04-28 00:05:57,476 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:05:58,712 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-28 00:05:59,763 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:06:00,952 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:06:02,209 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.10.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_self_attn_k_proj.safetensors True
Layer: model.layers.10.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [5.6925821e-03 7.8197168e-05 1.9827254e-05 1.3370723e-05 1.1338768e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-28 00:06:30,526 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-28 00:06:30,526 - INFO - Replacing 'model.layers.10.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-28 00:06:30,529 - INFO - Compression finished. 
2025-04-28 00:06:53,875 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:39,  1.95s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:03<00:28,  1.52s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:04<00:24,  1.38s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:05<00:22,  1.31s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:20,  1.28s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:08<00:18,  1.25s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:09<00:17,  1.24s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:10<00:16,  1.23s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:11<00:14,  1.23s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.22s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:14<00:12,  1.22s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:15<00:10,  1.22s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:16<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:17<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:20<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:21<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:22<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.23s/it]
2025-04-28 00:07:25,548 - INFO - wikitext2 perplexity: 6.9375
2025-04-28 00:07:25,548 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:07:35,625 - INFO - ptb perplexity: 25.7500
2025-04-28 00:07:35,625 - INFO - Evaluation results:
2025-04-28 00:07:35,626 - INFO -   wikitext2: 6.9375
2025-04-28 00:07:35,626 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.27it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.42it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.69it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.59it/s]
2025-04-28 00:07:37,886 - INFO - Layer: model.layers.10.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-28 00:07:37,888 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_self_attn_v_proj.safetensors
2025-04-28 00:07:37,888 - INFO - exists: True
2025-04-28 00:07:37,897 - INFO - factorize_layer_kron_svd
2025-04-28 00:07:39,163 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:07:40,390 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-28 00:07:41,453 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:07:42,633 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:07:43,874 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.10.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_self_attn_v_proj.safetensors True
Layer: model.layers.10.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.9614631e-03 5.2652311e-05 1.7582579e-05 1.3576366e-05 1.1561120e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-28 00:08:13,523 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-28 00:08:13,523 - INFO - Replacing 'model.layers.10.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-28 00:08:13,526 - INFO - Compression finished. 
2025-04-28 00:08:16,481 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-28 00:08:46,988 - INFO - wikitext2 perplexity: 6.8750
2025-04-28 00:08:46,988 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9296875
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:08:56,961 - INFO - ptb perplexity: 25.7500
2025-04-28 00:08:56,961 - INFO - Evaluation results:
2025-04-28 00:08:56,961 - INFO -   wikitext2: 6.8750
2025-04-28 00:08:56,961 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.29it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.44it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.79it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.66it/s]
2025-04-28 00:08:59,138 - INFO - Layer: model.layers.10.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-28 00:08:59,140 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_self_attn_o_proj.safetensors
2025-04-28 00:08:59,140 - INFO - exists: True
2025-04-28 00:08:59,154 - INFO - factorize_layer_kron_svd
2025-04-28 00:09:00,415 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:09:01,595 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:09:02,830 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-28 00:09:03,924 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:09:05,185 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.10.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_self_attn_o_proj.safetensors True
Layer: model.layers.10.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [3.7424755e-03 3.8448230e-05 1.9329273e-05 1.9253330e-05 1.8284118e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-28 00:09:33,352 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-28 00:09:33,353 - INFO - Replacing 'model.layers.10.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-28 00:09:33,356 - INFO - Compression finished. 
2025-04-28 00:09:36,306 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-28 00:10:06,482 - INFO - wikitext2 perplexity: 6.9375
2025-04-28 00:10:06,483 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:10:16,432 - INFO - ptb perplexity: 26.2500
2025-04-28 00:10:16,433 - INFO - Evaluation results:
2025-04-28 00:10:16,433 - INFO -   wikitext2: 6.9375
2025-04-28 00:10:16,433 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.46it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.42it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.64it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.58it/s]
2025-04-28 00:10:18,827 - INFO - Layer: model.layers.10.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-28 00:10:18,831 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_mlp_gate_proj.safetensors
2025-04-28 00:10:18,832 - INFO - exists: True
2025-04-28 00:10:18,928 - INFO - factorize_layer_kron_svd
2025-04-28 00:10:21,908 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:10:22,960 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:10:24,000 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-28 00:10:25,018 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-28 00:10:26,053 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-28 00:10:27,225 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-28 00:10:36,351 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:10:47,399 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:10:55,694 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-28 00:10:57,751 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-28 00:10:59,619 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-28 00:11:02,664 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.10.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_mlp_gate_proj.safetensors True
Layer: model.layers.10.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [1.3108423e-05 7.4565323e-06 6.9233306e-06 6.8009563e-06 6.7005799e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-28 00:12:03,237 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-28 00:12:03,237 - INFO - Replacing 'model.layers.10.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-28 00:12:03,244 - INFO - Compression finished. 
2025-04-28 00:12:09,243 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-28 00:12:39,972 - INFO - wikitext2 perplexity: 7.1562
2025-04-28 00:12:39,972 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.96875
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:12:50,087 - INFO - ptb perplexity: 26.6250
2025-04-28 00:12:50,088 - INFO - Evaluation results:
2025-04-28 00:12:50,088 - INFO -   wikitext2: 7.1562
2025-04-28 00:12:50,088 - INFO -   ptb: 26.6250
nlls.shape torch.Size([16376])
Mean NLL: 3.28125
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.25it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.41it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:02<00:00,  1.55it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:02<00:00,  1.49it/s]
2025-04-28 00:12:52,669 - INFO - Layer: model.layers.10.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-28 00:12:52,671 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_mlp_up_proj.safetensors
2025-04-28 00:12:52,671 - INFO - exists: True
2025-04-28 00:12:52,696 - INFO - factorize_layer_kron_svd
2025-04-28 00:12:53,945 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:12:55,189 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:12:56,484 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-28 00:12:58,143 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:13:01,896 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.10.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_mlp_up_proj.safetensors True
Layer: model.layers.10.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [2.4830976e-03 1.3603101e-04 2.3816692e-05 2.0194741e-05 1.6129978e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-28 00:14:06,033 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-28 00:14:06,034 - INFO - Replacing 'model.layers.10.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-28 00:14:06,040 - INFO - Compression finished. 
2025-04-28 00:14:13,167 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-28 00:14:43,626 - INFO - wikitext2 perplexity: 7.2188
2025-04-28 00:14:43,627 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9765625
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:14:53,856 - INFO - ptb perplexity: 27.0000
2025-04-28 00:14:53,856 - INFO - Evaluation results:
2025-04-28 00:14:53,856 - INFO -   wikitext2: 7.2188
2025-04-28 00:14:53,856 - INFO -   ptb: 27.0000
nlls.shape torch.Size([16376])
Mean NLL: 3.296875
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.56it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.48it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.63it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.60it/s]
2025-04-28 00:14:56,112 - INFO - Layer: model.layers.10.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-28 00:14:56,113 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_mlp_down_proj.safetensors
2025-04-28 00:14:56,113 - INFO - exists: True
2025-04-28 00:14:56,167 - INFO - factorize_layer_kron_svd
2025-04-28 00:14:58,670 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:15:01,384 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:15:05,084 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-28 00:15:06,145 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:15:07,342 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:15:08,618 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.10.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_10_mlp_down_proj.safetensors True
Layer: model.layers.10.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [0.05109505 0.00017506 0.00013073 0.00011839 0.00010639]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-28 00:16:21,404 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-28 00:16:21,405 - INFO - Replacing 'model.layers.10.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-28 00:16:21,411 - INFO - Compression finished. 
2025-04-28 00:16:28,063 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-28 00:16:58,110 - INFO - wikitext2 perplexity: 7.0625
2025-04-28 00:16:58,110 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:17:08,026 - INFO - ptb perplexity: 26.2500
2025-04-28 00:17:08,026 - INFO - Evaluation results:
2025-04-28 00:17:08,026 - INFO -   wikitext2: 7.0625
2025-04-28 00:17:08,026 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.37it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.45it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.64it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.58it/s]
2025-04-28 00:17:10,293 - INFO - Layer: model.layers.20.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-28 00:17:10,295 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_self_attn_q_proj.safetensors
2025-04-28 00:17:10,295 - INFO - exists: True
2025-04-28 00:17:10,309 - INFO - factorize_layer_kron_svd
2025-04-28 00:17:11,407 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:17:12,610 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:17:13,844 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-28 00:17:14,897 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:17:16,116 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.20.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_self_attn_q_proj.safetensors True
Layer: model.layers.20.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [4.4606850e-03 4.5190627e-05 1.3593499e-05 8.2705919e-06 6.7053229e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-28 00:17:45,463 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-28 00:17:45,464 - INFO - Replacing 'model.layers.20.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-28 00:17:45,465 - INFO - Compression finished. 
2025-04-28 00:17:50,179 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-28 00:18:21,906 - INFO - wikitext2 perplexity: 6.9375
2025-04-28 00:18:21,906 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:18:31,904 - INFO - ptb perplexity: 25.3750
2025-04-28 00:18:31,905 - INFO - Evaluation results:
2025-04-28 00:18:31,905 - INFO -   wikitext2: 6.9375
2025-04-28 00:18:31,905 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.29it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.36it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.64it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.55it/s]
2025-04-28 00:18:34,202 - INFO - Layer: model.layers.20.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-28 00:18:34,204 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_self_attn_k_proj.safetensors
2025-04-28 00:18:34,204 - INFO - exists: True
2025-04-28 00:18:34,212 - INFO - factorize_layer_kron_svd
2025-04-28 00:18:35,255 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:18:36,311 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:18:37,348 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-28 00:18:38,373 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-28 00:18:39,398 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-28 00:18:40,576 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-28 00:18:41,595 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:18:42,631 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:18:43,709 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-28 00:18:44,801 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-28 00:18:45,871 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-28 00:18:47,059 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.20.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_self_attn_k_proj.safetensors True
Layer: model.layers.20.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.4135268e-05 7.4927229e-06 6.9492476e-06 6.6774937e-06 6.5975196e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-28 00:19:15,457 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-28 00:19:15,457 - INFO - Replacing 'model.layers.20.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-28 00:19:15,459 - INFO - Compression finished. 
2025-04-28 00:19:19,394 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-28 00:19:49,627 - INFO - wikitext2 perplexity: 6.9375
2025-04-28 00:19:49,627 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:19:59,580 - INFO - ptb perplexity: 25.3750
2025-04-28 00:19:59,581 - INFO - Evaluation results:
2025-04-28 00:19:59,581 - INFO -   wikitext2: 6.9375
2025-04-28 00:19:59,581 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.28it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.47it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.72it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.61it/s]
2025-04-28 00:20:01,825 - INFO - Layer: model.layers.20.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-28 00:20:01,827 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_self_attn_v_proj.safetensors
2025-04-28 00:20:01,827 - INFO - exists: True
2025-04-28 00:20:01,837 - INFO - factorize_layer_kron_svd
2025-04-28 00:20:02,981 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:20:04,218 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-28 00:20:05,313 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:20:06,514 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:20:07,784 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.20.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_self_attn_v_proj.safetensors True
Layer: model.layers.20.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [4.3065422e-03 1.3948273e-05 1.2205875e-05 1.0264438e-05 9.0205649e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-28 00:20:29,882 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-28 00:20:29,882 - INFO - Replacing 'model.layers.20.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-28 00:20:29,884 - INFO - Compression finished. 
2025-04-28 00:20:32,345 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-28 00:21:02,579 - INFO - wikitext2 perplexity: 6.9375
2025-04-28 00:21:02,580 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:21:12,525 - INFO - ptb perplexity: 25.3750
2025-04-28 00:21:12,526 - INFO - Evaluation results:
2025-04-28 00:21:12,526 - INFO -   wikitext2: 6.9375
2025-04-28 00:21:12,526 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.33it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.41it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.65it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.57it/s]
2025-04-28 00:21:14,817 - INFO - Layer: model.layers.20.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-28 00:21:14,818 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_self_attn_o_proj.safetensors
2025-04-28 00:21:14,818 - INFO - exists: True
2025-04-28 00:21:14,826 - INFO - factorize_layer_kron_svd
2025-04-28 00:21:15,914 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:21:17,084 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:21:18,300 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-28 00:21:19,381 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:21:20,608 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.20.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_self_attn_o_proj.safetensors True
Layer: model.layers.20.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [9.5645310e-03 1.6217633e-05 1.5436419e-05 1.3552441e-05 1.2066335e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-28 00:21:42,477 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-28 00:21:42,477 - INFO - Replacing 'model.layers.20.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-28 00:21:42,479 - INFO - Compression finished. 
2025-04-28 00:21:45,775 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:02<00:23,  1.21s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:23<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-28 00:22:17,375 - INFO - wikitext2 perplexity: 6.9375
2025-04-28 00:22:17,375 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:22:27,353 - INFO - ptb perplexity: 25.3750
2025-04-28 00:22:27,353 - INFO - Evaluation results:
2025-04-28 00:22:27,353 - INFO -   wikitext2: 6.9375
2025-04-28 00:22:27,354 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.18it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.38it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.76it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.60it/s]
2025-04-28 00:22:29,614 - INFO - Layer: model.layers.20.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-28 00:22:29,616 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_mlp_gate_proj.safetensors
2025-04-28 00:22:29,616 - INFO - exists: True
2025-04-28 00:22:29,623 - INFO - factorize_layer_kron_svd
2025-04-28 00:22:30,825 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:22:31,996 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:22:33,213 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-28 00:22:34,978 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:22:38,098 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.20.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_mlp_gate_proj.safetensors True
Layer: model.layers.20.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [5.6294589e-03 2.1218650e-05 1.5237835e-05 1.4524096e-05 1.3646030e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-28 00:23:22,868 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-28 00:23:22,868 - INFO - Replacing 'model.layers.20.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-28 00:23:22,873 - INFO - Compression finished. 
2025-04-28 00:23:25,089 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-28 00:23:55,937 - INFO - wikitext2 perplexity: 7.0625
2025-04-28 00:23:55,937 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:24:05,961 - INFO - ptb perplexity: 25.7500
2025-04-28 00:24:05,961 - INFO - Evaluation results:
2025-04-28 00:24:05,961 - INFO -   wikitext2: 7.0625
2025-04-28 00:24:05,961 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.55it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.54it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.80it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.72it/s]
2025-04-28 00:24:08,276 - INFO - Layer: model.layers.20.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-28 00:24:08,278 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_mlp_up_proj.safetensors
2025-04-28 00:24:08,278 - INFO - exists: True
2025-04-28 00:24:08,288 - INFO - factorize_layer_kron_svd
2025-04-28 00:24:09,452 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:24:10,479 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:24:11,516 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-28 00:24:12,545 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-28 00:24:13,591 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-28 00:24:14,786 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-28 00:24:16,356 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:24:18,164 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:24:20,009 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-28 00:24:21,848 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-28 00:24:23,709 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-28 00:24:26,794 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.20.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_mlp_up_proj.safetensors True
Layer: model.layers.20.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [6.0963253e-06 5.4725215e-06 4.6369269e-06 4.5791958e-06 4.4192011e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-28 00:25:10,271 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-28 00:25:10,271 - INFO - Replacing 'model.layers.20.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-28 00:25:10,277 - INFO - Compression finished. 
2025-04-28 00:25:12,015 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-28 00:25:42,163 - INFO - wikitext2 perplexity: 7.0625
2025-04-28 00:25:42,163 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:25:52,155 - INFO - ptb perplexity: 25.7500
2025-04-28 00:25:52,155 - INFO - Evaluation results:
2025-04-28 00:25:52,155 - INFO -   wikitext2: 7.0625
2025-04-28 00:25:52,155 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.51it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.52it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.75it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.68it/s]
2025-04-28 00:25:54,298 - INFO - Layer: model.layers.20.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-28 00:25:54,300 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_mlp_down_proj.safetensors
2025-04-28 00:25:54,300 - INFO - exists: True
2025-04-28 00:25:54,317 - INFO - factorize_layer_kron_svd
2025-04-28 00:25:56,105 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:25:57,969 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:25:59,822 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-28 00:26:01,686 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-28 00:26:03,555 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-28 00:26:06,644 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-28 00:26:07,711 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-28 00:26:08,798 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-28 00:26:09,879 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-28 00:26:10,981 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-28 00:26:12,095 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-28 00:26:13,327 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.20.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_20_mlp_down_proj.safetensors True
Layer: model.layers.20.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [5.1172728e-06 4.9718492e-06 4.6187934e-06 4.4592139e-06 4.1195922e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-28 00:27:05,228 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-28 00:27:05,228 - INFO - Replacing 'model.layers.20.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-28 00:27:05,234 - INFO - Compression finished. 
2025-04-28 00:27:09,827 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                                                                                                                                          | 0/21 [00:00<?, ?it/s]Evaluating:   5%|████████▍                                                                                                                                                                         | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|████████████████▉                                                                                                                                                                 | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|█████████████████████████▍                                                                                                                                                        | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|█████████████████████████████████▉                                                                                                                                                | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████████████████████████████████▍                                                                                                                                       | 5/21 [00:06<00:19,  1.21s/it]Evaluating:  29%|██████████████████████████████████████████████████▊                                                                                                                               | 6/21 [00:07<00:18,  1.21s/it]Evaluating:  33%|███████████████████████████████████████████████████████████▎                                                                                                                      | 7/21 [00:08<00:16,  1.21s/it]Evaluating:  38%|███████████████████████████████████████████████████████████████████▊                                                                                                              | 8/21 [00:09<00:15,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▎                                                                                                     | 9/21 [00:10<00:14,  1.21s/it]Evaluating:  48%|████████████████████████████████████████████████████████████████████████████████████▎                                                                                            | 10/21 [00:12<00:13,  1.21s/it]Evaluating:  52%|████████████████████████████████████████████████████████████████████████████████████████████▋                                                                                    | 11/21 [00:13<00:12,  1.21s/it]Evaluating:  57%|█████████████████████████████████████████████████████████████████████████████████████████████████████▏                                                                           | 12/21 [00:14<00:10,  1.21s/it]Evaluating:  62%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                                                   | 13/21 [00:15<00:09,  1.21s/it]Evaluating:  67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                                           | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                                  | 15/21 [00:18<00:07,  1.21s/it]Evaluating:  76%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                          | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 17/21 [00:20<00:04,  1.21s/it]Evaluating:  86%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                         | 18/21 [00:21<00:03,  1.21s/it]Evaluating:  90%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 19/21 [00:22<00:02,  1.21s/it]Evaluating:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 20/21 [00:24<00:01,  1.21s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 21/21 [00:25<00:00,  1.20s/it]
2025-04-28 00:27:40,127 - INFO - wikitext2 perplexity: 7.1562
2025-04-28 00:27:40,127 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.96875
Evaluating:   0%|                                                                                                                                                                                           | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████████████████████▌                                                                                                                                                         | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|███████████████████████████████████████████████████▏                                                                                                                               | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|████████████████████████████████████████████████████████████████████████████▋                                                                                                      | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                                            | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                                   | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-28 00:27:50,027 - INFO - ptb perplexity: 26.2500
2025-04-28 00:27:50,027 - INFO - Evaluation results:
2025-04-28 00:27:50,028 - INFO -   wikitext2: 7.1562
2025-04-28 00:27:50,028 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                                                                                                                                            | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|██████████████████████████████████████████████████████▋                                                                                                             | 1/3 [00:00<00:01,  1.07it/s]Loading checkpoint shards:  67%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                                      | 2/3 [00:01<00:00,  1.35it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.65it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:01<00:00,  1.51it/s]



dct
{'model.layers.10.self_attn.q_proj': [6.9375, 25.75], 'model.layers.10.self_attn.k_proj': [6.9375, 25.75], 'model.layers.10.self_attn.v_proj': [6.875, 25.75], 'model.layers.10.self_attn.o_proj': [6.9375, 26.25], 'model.layers.10.mlp.gate_proj': [7.15625, 26.625], 'model.layers.10.mlp.up_proj': [7.21875, 27.0], 'model.layers.10.mlp.down_proj': [7.0625, 26.25], 'model.layers.20.self_attn.q_proj': [6.9375, 25.375], 'model.layers.20.self_attn.k_proj': [6.9375, 25.375], 'model.layers.20.self_attn.v_proj': [6.9375, 25.375], 'model.layers.20.self_attn.o_proj': [6.9375, 25.375], 'model.layers.20.mlp.gate_proj': [7.0625, 25.75], 'model.layers.20.mlp.up_proj': [7.0625, 25.75], 'model.layers.20.mlp.down_proj': [7.15625, 26.25]}
