2025-04-27 01:47:56,644 - INFO - Loading model: unsloth/llama-2-7b-chat
[2025-04-27 01:48:01,406] [INFO] [real_accelerator.py:222:get_accelerator] Setting ds_accelerator to cuda (auto detect)
Warning: The cache directory for DeepSpeed Triton autotune, /home/jovyan/.triton/autotune, appears to be on an NFS system. While this is generally acceptable, if you experience slowdowns or hanging when DeepSpeed exits, it is recommended to set the TRITON_CACHE_DIR environment variable to a non-NFS path.
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.26s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.19s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.54s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.99s/it]
2025-04-27 01:48:40,403 - INFO - Model loaded with dtype torch.bfloat16
2025-04-27 01:49:31,359 - INFO - Model moved to cuda:0
2025-04-27 01:49:31,361 - INFO - Total parameters before compression: 6738415616
2025-04-27 01:49:31,362 - INFO - Layer: model.layers.21.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:49:31,365 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_self_attn_q_proj.safetensors
2025-04-27 01:49:31,365 - INFO - exists: True
2025-04-27 01:49:31,381 - INFO - factorize_layer_kron_svd
2025-04-27 01:49:33,532 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:49:35,358 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:49:37,175 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:49:38,793 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:49:40,557 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.21.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_self_attn_q_proj.safetensors True
Layer: model.layers.21.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [4.9928338e-03 1.8311075e-05 9.7191369e-06 7.7809100e-06 5.9942731e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:50:21,408 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:50:21,408 - INFO - Replacing 'model.layers.21.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 01:50:21,408 - INFO - Compression finished. 
2025-04-27 01:50:21,413 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:03<01:06,  3.31s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:04<00:38,  2.05s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:05<00:29,  1.65s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:06<00:24,  1.47s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:08<00:21,  1.36s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:09<00:19,  1.30s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:10<00:17,  1.26s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:11<00:16,  1.24s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:12<00:14,  1.22s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:13<00:13,  1.21s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:15<00:12,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:16<00:10,  1.20s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:17<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:18<00:08,  1.19s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:19<00:07,  1.19s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:21<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:22<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:23<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:24<00:02,  1.25s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:25<00:01,  1.23s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:26<00:00,  1.13s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:26<00:00,  1.28s/it]
2025-04-27 01:50:56,073 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:50:56,073 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.19s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 01:51:06,708 - INFO - ptb perplexity: 25.7500
2025-04-27 01:51:06,708 - INFO - Evaluation results:
2025-04-27 01:51:06,708 - INFO -   wikitext2: 6.9375
2025-04-27 01:51:06,708 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.76s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:27<00:13, 13.71s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:37<00:00, 12.21s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:37<00:00, 12.62s/it]
2025-04-27 01:51:44,977 - INFO - Layer: model.layers.21.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:51:44,991 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_self_attn_k_proj.safetensors
2025-04-27 01:51:44,991 - INFO - exists: True
2025-04-27 01:51:45,015 - INFO - factorize_layer_kron_svd
2025-04-27 01:51:47,049 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:51:48,717 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:51:50,472 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:51:51,972 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:51:53,751 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.21.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_self_attn_k_proj.safetensors True
Layer: model.layers.21.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.3128020e-03 9.2708731e-05 9.0614503e-06 4.9129476e-06 3.1025263e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:52:38,493 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:52:38,493 - INFO - Replacing 'model.layers.21.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 01:52:38,495 - INFO - Compression finished. 
2025-04-27 01:53:05,827 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:27,  1.39s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:23,  1.26s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:22,  1.22s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:06<00:19,  1.20s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.19s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.19s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.19s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.19s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:12<00:13,  1.19s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.19s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 01:53:36,563 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:53:36,563 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.18s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 01:53:46,421 - INFO - ptb perplexity: 25.7500
2025-04-27 01:53:46,421 - INFO - Evaluation results:
2025-04-27 01:53:46,421 - INFO -   wikitext2: 6.9375
2025-04-27 01:53:46,421 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.93s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:27<00:13, 13.97s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:37<00:00, 11.90s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:37<00:00, 12.46s/it]
2025-04-27 01:54:24,560 - INFO - Layer: model.layers.21.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:54:24,564 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_self_attn_v_proj.safetensors
2025-04-27 01:54:24,564 - INFO - exists: True
2025-04-27 01:54:24,583 - INFO - factorize_layer_kron_svd
2025-04-27 01:54:26,408 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:54:28,127 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 01:54:29,595 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:54:31,224 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:54:33,049 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.21.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_self_attn_v_proj.safetensors True
Layer: model.layers.21.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.9529214e-03 7.7000013e-06 6.5920690e-06 6.2058962e-06 5.7856682e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:55:15,700 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:55:15,700 - INFO - Replacing 'model.layers.21.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 01:55:15,703 - INFO - Compression finished. 
2025-04-27 01:55:26,379 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 01:55:56,633 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 01:55:56,633 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.18s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 01:56:06,483 - INFO - ptb perplexity: 25.7500
2025-04-27 01:56:06,483 - INFO - Evaluation results:
2025-04-27 01:56:06,483 - INFO -   wikitext2: 6.9375
2025-04-27 01:56:06,483 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:14<00:28, 14.43s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:28<00:14, 14.21s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:38<00:00, 12.09s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:38<00:00, 12.68s/it]
2025-04-27 01:56:44,914 - INFO - Layer: model.layers.21.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 01:56:44,918 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_self_attn_o_proj.safetensors
2025-04-27 01:56:44,918 - INFO - exists: True
2025-04-27 01:56:44,936 - INFO - factorize_layer_kron_svd
2025-04-27 01:56:46,808 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:56:48,444 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:56:50,221 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 01:56:51,795 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:56:53,549 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.21.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_self_attn_o_proj.safetensors True
Layer: model.layers.21.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [3.4091754e-03 1.6454322e-05 8.1323160e-06 6.9248763e-06 6.8448871e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 01:57:38,015 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 01:57:38,015 - INFO - Replacing 'model.layers.21.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 01:57:38,017 - INFO - Compression finished. 
2025-04-27 01:57:45,592 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 01:58:15,736 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 01:58:15,736 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 01:58:25,583 - INFO - ptb perplexity: 25.7500
2025-04-27 01:58:25,584 - INFO - Evaluation results:
2025-04-27 01:58:25,584 - INFO -   wikitext2: 7.0000
2025-04-27 01:58:25,584 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.65s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.41s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.37s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.95s/it]
2025-04-27 01:59:01,861 - INFO - Layer: model.layers.21.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 01:59:01,867 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_mlp_gate_proj.safetensors
2025-04-27 01:59:01,867 - INFO - exists: True
2025-04-27 01:59:01,879 - INFO - factorize_layer_kron_svd
2025-04-27 01:59:04,522 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:59:06,029 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:59:07,547 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 01:59:09,003 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 01:59:10,418 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 01:59:12,161 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 01:59:14,907 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 01:59:17,557 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 01:59:20,331 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 01:59:22,842 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 01:59:25,395 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 01:59:30,748 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.21.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_mlp_gate_proj.safetensors True
Layer: model.layers.21.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [1.2092188e-05 6.4029141e-06 6.1038627e-06 5.6923504e-06 5.6428335e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 02:01:04,460 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 02:01:04,461 - INFO - Replacing 'model.layers.21.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 02:01:04,466 - INFO - Compression finished. 
2025-04-27 02:01:11,656 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:01:41,552 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 02:01:41,552 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.17s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 02:01:51,404 - INFO - ptb perplexity: 25.7500
2025-04-27 02:01:51,404 - INFO - Evaluation results:
2025-04-27 02:01:51,404 - INFO -   wikitext2: 7.0625
2025-04-27 02:01:51,404 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.59s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:27<00:13, 13.61s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.55s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.11s/it]
2025-04-27 02:02:28,297 - INFO - Layer: model.layers.21.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 02:02:28,299 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_mlp_up_proj.safetensors
2025-04-27 02:02:28,300 - INFO - exists: True
2025-04-27 02:02:28,313 - INFO - factorize_layer_kron_svd
2025-04-27 02:02:30,327 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:02:31,933 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:02:33,647 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:02:36,202 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:02:41,251 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.21.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_mlp_up_proj.safetensors True
Layer: model.layers.21.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [1.8695735e-03 5.5963137e-05 1.4356574e-05 1.3274203e-05 1.2030486e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 02:03:56,150 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 02:03:56,151 - INFO - Replacing 'model.layers.21.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 02:03:56,157 - INFO - Compression finished. 
2025-04-27 02:04:10,019 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:04:40,666 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 02:04:40,666 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.17s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 02:04:50,532 - INFO - ptb perplexity: 25.7500
2025-04-27 02:04:50,532 - INFO - Evaluation results:
2025-04-27 02:04:50,532 - INFO -   wikitext2: 7.0625
2025-04-27 02:04:50,532 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.45s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:27<00:13, 13.63s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.78s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.26s/it]
2025-04-27 02:05:27,705 - INFO - Layer: model.layers.21.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 02:05:27,711 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_mlp_down_proj.safetensors
2025-04-27 02:05:27,711 - INFO - exists: True
2025-04-27 02:05:27,775 - INFO - factorize_layer_kron_svd
2025-04-27 02:05:30,383 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:05:33,465 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:05:38,055 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:05:39,575 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:05:41,234 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:05:43,013 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.21.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_21_mlp_down_proj.safetensors True
Layer: model.layers.21.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [4.5640193e-02 9.2487091e-05 5.4519722e-05 4.7700971e-05 3.9835424e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 02:07:17,736 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 02:07:17,736 - INFO - Replacing 'model.layers.21.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 02:07:17,744 - INFO - Compression finished. 
2025-04-27 02:07:31,525 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:08:01,679 - INFO - wikitext2 perplexity: 7.0938
2025-04-27 02:08:01,679 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9609375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 02:08:11,737 - INFO - ptb perplexity: 25.7500
2025-04-27 02:08:11,737 - INFO - Evaluation results:
2025-04-27 02:08:11,737 - INFO -   wikitext2: 7.0938
2025-04-27 02:08:11,737 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.37s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.12s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.36s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.86s/it]
2025-04-27 02:08:47,696 - INFO - Layer: model.layers.22.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:08:47,699 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_self_attn_q_proj.safetensors
2025-04-27 02:08:47,699 - INFO - exists: True
2025-04-27 02:08:47,740 - INFO - factorize_layer_kron_svd
2025-04-27 02:08:49,621 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:08:51,305 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:08:53,019 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:08:54,528 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:08:56,165 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.22.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_self_attn_q_proj.safetensors True
Layer: model.layers.22.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.1946917e-02 1.2984767e-05 8.3072391e-06 7.5305643e-06 5.4214579e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:09:34,603 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:09:34,603 - INFO - Replacing 'model.layers.22.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 02:09:34,607 - INFO - Compression finished. 
2025-04-27 02:09:48,865 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:10:18,965 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 02:10:18,965 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.20s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 02:10:29,250 - INFO - ptb perplexity: 25.7500
2025-04-27 02:10:29,250 - INFO - Evaluation results:
2025-04-27 02:10:29,250 - INFO -   wikitext2: 6.9375
2025-04-27 02:10:29,250 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:12<00:25, 12.83s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.19s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.40s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.84s/it]
2025-04-27 02:11:05,311 - INFO - Layer: model.layers.22.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:11:05,314 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_self_attn_k_proj.safetensors
2025-04-27 02:11:05,314 - INFO - exists: True
2025-04-27 02:11:05,346 - INFO - factorize_layer_kron_svd
2025-04-27 02:11:07,772 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:11:09,410 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:11:11,100 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:11:12,575 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:11:14,321 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.22.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_self_attn_k_proj.safetensors True
Layer: model.layers.22.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.2188591e-02 2.6197076e-05 5.1536390e-06 4.7172689e-06 4.2818610e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:11:52,900 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:11:52,900 - INFO - Replacing 'model.layers.22.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 02:11:52,903 - INFO - Compression finished. 
2025-04-27 02:12:01,309 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:12:32,110 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 02:12:32,111 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.18s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 02:12:41,999 - INFO - ptb perplexity: 25.7500
2025-04-27 02:12:41,999 - INFO - Evaluation results:
2025-04-27 02:12:42,000 - INFO -   wikitext2: 6.9375
2025-04-27 02:12:42,000 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.02s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:12, 13.00s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.38s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.82s/it]
2025-04-27 02:13:18,016 - INFO - Layer: model.layers.22.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:13:18,055 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_self_attn_v_proj.safetensors
2025-04-27 02:13:18,056 - INFO - exists: True
2025-04-27 02:13:18,121 - INFO - factorize_layer_kron_svd
2025-04-27 02:13:20,361 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:13:21,869 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:13:23,338 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 02:13:24,819 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 02:13:26,291 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 02:13:28,049 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 02:13:29,480 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:13:30,940 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:13:32,413 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 02:13:33,885 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 02:13:35,380 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 02:13:37,134 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.22.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_self_attn_v_proj.safetensors True
Layer: model.layers.22.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.6961297e-06 2.6871849e-06 2.6695091e-06 2.6209382e-06 2.5850989e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:14:15,783 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:14:15,784 - INFO - Replacing 'model.layers.22.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 02:14:15,787 - INFO - Compression finished. 
2025-04-27 02:14:25,199 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:14:55,530 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 02:14:55,530 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.18s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 02:15:05,360 - INFO - ptb perplexity: 25.7500
2025-04-27 02:15:05,360 - INFO - Evaluation results:
2025-04-27 02:15:05,360 - INFO -   wikitext2: 6.9375
2025-04-27 02:15:05,360 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.66s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:27<00:13, 13.48s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.41s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.99s/it]
2025-04-27 02:15:41,704 - INFO - Layer: model.layers.22.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:15:41,708 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_self_attn_o_proj.safetensors
2025-04-27 02:15:41,708 - INFO - exists: True
2025-04-27 02:15:41,731 - INFO - factorize_layer_kron_svd
2025-04-27 02:15:43,703 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:15:45,741 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 02:15:47,242 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:15:48,918 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.22.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_self_attn_o_proj.safetensors True
Layer: model.layers.22.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.4106883e-03 1.2815704e-05 8.4025032e-06 7.8259582e-06 6.7436308e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:16:30,601 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:16:30,601 - INFO - Replacing 'model.layers.22.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 02:16:30,605 - INFO - Compression finished. 
2025-04-27 02:16:45,181 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:17:15,187 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 02:17:15,188 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 02:17:25,476 - INFO - ptb perplexity: 25.7500
2025-04-27 02:17:25,477 - INFO - Evaluation results:
2025-04-27 02:17:25,477 - INFO -   wikitext2: 7.0000
2025-04-27 02:17:25,477 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.23s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.25s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.42s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.91s/it]
2025-04-27 02:18:01,600 - INFO - Layer: model.layers.22.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 02:18:01,604 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_mlp_gate_proj.safetensors
2025-04-27 02:18:01,604 - INFO - exists: True
2025-04-27 02:18:01,611 - INFO - factorize_layer_kron_svd
2025-04-27 02:18:03,433 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:18:04,917 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:18:06,441 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 02:18:07,888 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 02:18:09,412 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 02:18:11,124 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 02:18:13,325 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:18:15,837 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:18:18,289 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 02:18:20,949 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 02:18:23,388 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 02:18:28,227 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.22.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_mlp_gate_proj.safetensors True
Layer: model.layers.22.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [1.1882697e-05 6.5561608e-06 6.1485889e-06 6.0917669e-06 5.8484889e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 02:19:51,648 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 02:19:51,649 - INFO - Replacing 'model.layers.22.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 02:19:51,657 - INFO - Compression finished. 
2025-04-27 02:20:00,709 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:20:30,573 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 02:20:30,574 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 02:20:40,512 - INFO - ptb perplexity: 25.7500
2025-04-27 02:20:40,512 - INFO - Evaluation results:
2025-04-27 02:20:40,512 - INFO -   wikitext2: 7.0000
2025-04-27 02:20:40,512 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.60s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:12, 12.99s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.15s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.71s/it]
2025-04-27 02:21:16,014 - INFO - Layer: model.layers.22.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 02:21:16,017 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_mlp_up_proj.safetensors
2025-04-27 02:21:16,017 - INFO - exists: True
2025-04-27 02:21:16,080 - INFO - factorize_layer_kron_svd
2025-04-27 02:21:18,145 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:21:20,069 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:21:21,942 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:21:24,428 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:21:29,185 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.22.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_mlp_up_proj.safetensors True
Layer: model.layers.22.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [1.2615041e-03 2.1604352e-05 1.3284305e-05 1.1028132e-05 1.0561911e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 02:22:56,041 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 02:22:56,042 - INFO - Replacing 'model.layers.22.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 02:22:56,049 - INFO - Compression finished. 
2025-04-27 02:23:02,050 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:23:32,050 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 02:23:32,050 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 02:23:42,149 - INFO - ptb perplexity: 25.3750
2025-04-27 02:23:42,149 - INFO - Evaluation results:
2025-04-27 02:23:42,149 - INFO -   wikitext2: 7.0625
2025-04-27 02:23:42,149 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.74s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.34s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.48s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.02s/it]
2025-04-27 02:24:18,615 - INFO - Layer: model.layers.22.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 02:24:18,617 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_mlp_down_proj.safetensors
2025-04-27 02:24:18,617 - INFO - exists: True
2025-04-27 02:24:18,653 - INFO - factorize_layer_kron_svd
2025-04-27 02:24:21,566 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:24:24,891 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:24:30,061 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:24:31,611 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:24:33,438 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:24:35,317 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.22.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_22_mlp_down_proj.safetensors True
Layer: model.layers.22.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [2.3855805e-02 8.0862206e-05 5.0205126e-05 4.2752916e-05 3.9248724e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 02:26:24,755 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 02:26:24,756 - INFO - Replacing 'model.layers.22.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 02:26:24,762 - INFO - Compression finished. 
2025-04-27 02:26:33,247 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.19s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:27:03,374 - INFO - wikitext2 perplexity: 7.0938
2025-04-27 02:27:03,375 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9609375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.17s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.24s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:06<00:02,  1.23s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.22s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.20s/it]
2025-04-27 02:27:13,468 - INFO - ptb perplexity: 25.7500
2025-04-27 02:27:13,468 - INFO - Evaluation results:
2025-04-27 02:27:13,468 - INFO -   wikitext2: 7.0938
2025-04-27 02:27:13,468 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:26<00:53, 26.63s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:57<00:29, 29.17s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [01:17<00:00, 24.97s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [01:17<00:00, 25.85s/it]
2025-04-27 02:28:32,105 - INFO - Layer: model.layers.23.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:28:32,109 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_self_attn_q_proj.safetensors
2025-04-27 02:28:32,109 - INFO - exists: True
2025-04-27 02:28:32,173 - INFO - factorize_layer_kron_svd
2025-04-27 02:28:34,097 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:28:35,927 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:28:37,747 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:28:39,283 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:28:40,965 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.23.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_self_attn_q_proj.safetensors True
Layer: model.layers.23.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.4300436e-03 4.7485857e-05 8.7676408e-06 5.8501660e-06 4.9811219e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:29:19,799 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:29:19,800 - INFO - Replacing 'model.layers.23.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 02:29:19,802 - INFO - Compression finished. 
2025-04-27 02:29:26,896 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:29:58,338 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 02:29:58,338 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.22s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.20s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 02:30:08,797 - INFO - ptb perplexity: 25.7500
2025-04-27 02:30:08,798 - INFO - Evaluation results:
2025-04-27 02:30:08,798 - INFO -   wikitext2: 6.9375
2025-04-27 02:30:08,798 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.02s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:25<00:12, 12.98s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.18s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.67s/it]
2025-04-27 02:30:44,200 - INFO - Layer: model.layers.23.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:30:44,204 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_self_attn_k_proj.safetensors
2025-04-27 02:30:44,204 - INFO - exists: True
2025-04-27 02:30:44,216 - INFO - factorize_layer_kron_svd
2025-04-27 02:30:45,999 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:30:47,518 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:30:48,961 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 02:30:50,421 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 02:30:51,874 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 02:30:53,529 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 02:30:54,975 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:30:56,455 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:30:57,968 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 02:30:59,486 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 02:31:01,017 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 02:31:02,673 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.23.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_self_attn_k_proj.safetensors True
Layer: model.layers.23.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.2797020e-05 5.7854604e-06 5.6185331e-06 5.4496868e-06 5.2108535e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:31:41,003 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:31:41,004 - INFO - Replacing 'model.layers.23.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 02:31:41,007 - INFO - Compression finished. 
2025-04-27 02:31:55,759 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:32:25,766 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 02:32:25,767 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 02:32:35,792 - INFO - ptb perplexity: 25.7500
2025-04-27 02:32:35,793 - INFO - Evaluation results:
2025-04-27 02:32:35,793 - INFO -   wikitext2: 6.9375
2025-04-27 02:32:35,793 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.29s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.41s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.33s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.88s/it]
2025-04-27 02:33:11,797 - INFO - Layer: model.layers.23.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:33:11,801 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_self_attn_v_proj.safetensors
2025-04-27 02:33:11,801 - INFO - exists: True
2025-04-27 02:33:11,810 - INFO - factorize_layer_kron_svd
2025-04-27 02:33:13,693 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:33:15,452 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 02:33:16,989 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:33:18,684 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:33:20,660 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.23.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_self_attn_v_proj.safetensors True
Layer: model.layers.23.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.7558411e-03 1.2494936e-05 7.3878446e-06 7.0451447e-06 6.3593143e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:34:55,067 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:34:55,068 - INFO - Replacing 'model.layers.23.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 02:34:55,071 - INFO - Compression finished. 
2025-04-27 02:35:07,912 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:35:38,144 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 02:35:38,144 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.18s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 02:35:48,011 - INFO - ptb perplexity: 25.7500
2025-04-27 02:35:48,011 - INFO - Evaluation results:
2025-04-27 02:35:48,011 - INFO -   wikitext2: 6.9375
2025-04-27 02:35:48,011 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:14<00:29, 14.83s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:29<00:14, 14.87s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:41<00:00, 13.36s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:41<00:00, 13.77s/it]
2025-04-27 02:36:29,875 - INFO - Layer: model.layers.23.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:36:29,880 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_self_attn_o_proj.safetensors
2025-04-27 02:36:29,880 - INFO - exists: True
2025-04-27 02:36:29,901 - INFO - factorize_layer_kron_svd
2025-04-27 02:36:32,173 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:36:35,344 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 02:36:37,070 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:36:39,886 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.23.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_self_attn_o_proj.safetensors True
Layer: model.layers.23.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.0768274e-03 1.7249478e-05 6.7950791e-06 6.1193855e-06 5.5905148e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:38:11,665 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:38:11,665 - INFO - Replacing 'model.layers.23.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 02:38:11,668 - INFO - Compression finished. 
2025-04-27 02:38:24,445 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.20s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.20s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.20s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 02:38:54,784 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 02:38:54,784 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.20s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.20s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.20s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.20s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.18s/it]
2025-04-27 02:39:05,211 - INFO - ptb perplexity: 25.7500
2025-04-27 02:39:05,211 - INFO - Evaluation results:
2025-04-27 02:39:05,211 - INFO -   wikitext2: 7.0000
2025-04-27 02:39:05,211 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:21<00:42, 21.37s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:42<00:20, 20.98s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 18.07s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 18.89s/it]
2025-04-27 02:40:03,172 - INFO - Layer: model.layers.23.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 02:40:03,176 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_mlp_gate_proj.safetensors
2025-04-27 02:40:03,176 - INFO - exists: True
2025-04-27 02:40:03,183 - INFO - factorize_layer_kron_svd
2025-04-27 02:40:07,100 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:40:10,069 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:40:12,209 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:40:17,704 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:40:24,008 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.23.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_mlp_gate_proj.safetensors True
Layer: model.layers.23.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [1.6312244e-03 1.5538668e-05 4.1256385e-06 2.1622898e-06 2.0991954e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 02:42:16,479 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 02:42:16,479 - INFO - Replacing 'model.layers.23.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 02:42:16,487 - INFO - Compression finished. 
2025-04-27 02:42:32,081 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.19s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:43:03,001 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 02:43:03,001 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.20s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.20s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.20s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.20s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.18s/it]
2025-04-27 02:43:13,563 - INFO - ptb perplexity: 25.7500
2025-04-27 02:43:13,563 - INFO - Evaluation results:
2025-04-27 02:43:13,563 - INFO -   wikitext2: 7.0625
2025-04-27 02:43:13,563 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:21<00:42, 21.09s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:43<00:21, 21.61s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:57<00:00, 18.51s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:57<00:00, 19.30s/it]
2025-04-27 02:44:12,068 - INFO - Layer: model.layers.23.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 02:44:12,071 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_mlp_up_proj.safetensors
2025-04-27 02:44:12,071 - INFO - exists: True
2025-04-27 02:44:12,107 - INFO - factorize_layer_kron_svd
2025-04-27 02:44:18,266 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:44:21,273 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:44:23,896 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:44:29,317 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:44:34,793 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.23.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_mlp_up_proj.safetensors True
Layer: model.layers.23.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [6.2996458e-04 5.2627449e-05 1.1003272e-05 1.0211139e-05 8.8619527e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 02:46:27,092 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 02:46:27,092 - INFO - Replacing 'model.layers.23.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 02:46:27,100 - INFO - Compression finished. 
2025-04-27 02:46:41,676 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.19s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:47:12,963 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 02:47:12,963 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.20s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.20s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.20s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.20s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.18s/it]
2025-04-27 02:47:23,507 - INFO - ptb perplexity: 25.7500
2025-04-27 02:47:23,507 - INFO - Evaluation results:
2025-04-27 02:47:23,507 - INFO -   wikitext2: 7.0625
2025-04-27 02:47:23,507 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:21<00:42, 21.22s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:42<00:21, 21.44s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:57<00:00, 18.35s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:57<00:00, 19.16s/it]
2025-04-27 02:48:21,571 - INFO - Layer: model.layers.23.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 02:48:21,575 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_mlp_down_proj.safetensors
2025-04-27 02:48:21,575 - INFO - exists: True
2025-04-27 02:48:21,596 - INFO - factorize_layer_kron_svd
2025-04-27 02:48:26,899 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:48:32,073 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:48:40,078 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:48:42,169 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:48:43,842 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:48:46,804 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.23.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_23_mlp_down_proj.safetensors True
Layer: model.layers.23.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [6.6739982e-03 2.3223182e-04 4.9300255e-05 3.7862912e-05 3.5104458e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 02:51:44,867 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 02:51:44,867 - INFO - Replacing 'model.layers.23.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 02:51:44,876 - INFO - Compression finished. 
2025-04-27 02:52:01,603 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.20s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.19s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 02:52:32,268 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 02:52:32,268 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.19s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 02:52:42,607 - INFO - ptb perplexity: 25.7500
2025-04-27 02:52:42,607 - INFO - Evaluation results:
2025-04-27 02:52:42,607 - INFO -   wikitext2: 7.0625
2025-04-27 02:52:42,607 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:20<00:41, 20.99s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:42<00:21, 21.07s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 18.06s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 18.87s/it]
2025-04-27 02:53:40,173 - INFO - Layer: model.layers.24.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:53:40,178 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_self_attn_q_proj.safetensors
2025-04-27 02:53:40,179 - INFO - exists: True
2025-04-27 02:53:40,291 - INFO - factorize_layer_kron_svd
2025-04-27 02:53:44,697 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:53:48,475 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:53:52,192 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 02:53:55,298 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:53:57,408 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.24.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_self_attn_q_proj.safetensors True
Layer: model.layers.24.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [9.3926415e-03 2.3708692e-05 9.1289621e-06 5.9139638e-06 5.1298866e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:54:54,501 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:54:54,501 - INFO - Replacing 'model.layers.24.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 02:54:54,503 - INFO - Compression finished. 
2025-04-27 02:55:04,866 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:19,  1.20s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.20s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.20s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.20s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.20s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.20s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.20s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.20s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.20s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.20s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.20s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 02:55:35,771 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 02:55:35,771 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.19s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.20s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 02:55:46,511 - INFO - ptb perplexity: 25.7500
2025-04-27 02:55:46,511 - INFO - Evaluation results:
2025-04-27 02:55:46,511 - INFO -   wikitext2: 6.9375
2025-04-27 02:55:46,511 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:20<00:41, 20.99s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:42<00:21, 21.40s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:57<00:00, 18.30s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:57<00:00, 19.10s/it]
2025-04-27 02:56:44,373 - INFO - Layer: model.layers.24.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:56:44,377 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_self_attn_k_proj.safetensors
2025-04-27 02:56:44,377 - INFO - exists: True
2025-04-27 02:56:44,389 - INFO - factorize_layer_kron_svd
2025-04-27 02:56:48,500 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:56:51,165 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 02:56:53,069 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:56:56,868 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.24.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_self_attn_k_proj.safetensors True
Layer: model.layers.24.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.0369071e-02 1.0171949e-05 5.6428921e-06 4.9444534e-06 4.1125627e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 02:57:57,511 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 02:57:57,512 - INFO - Replacing 'model.layers.24.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 02:57:57,515 - INFO - Compression finished. 
2025-04-27 02:58:08,912 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.20s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.20s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:19,  1.20s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.20s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.20s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.20s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.20s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.20s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.20s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.20s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.20s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.20s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.20s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.19s/it]
2025-04-27 02:58:41,370 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 02:58:41,370 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.20s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.21s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.18s/it]
2025-04-27 02:58:51,911 - INFO - ptb perplexity: 25.7500
2025-04-27 02:58:51,912 - INFO - Evaluation results:
2025-04-27 02:58:51,912 - INFO -   wikitext2: 6.9375
2025-04-27 02:58:51,912 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.71s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:34<00:17, 17.73s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:49<00:00, 16.39s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:49<00:00, 16.35s/it]
2025-04-27 02:59:41,371 - INFO - Layer: model.layers.24.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 02:59:41,375 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_self_attn_v_proj.safetensors
2025-04-27 02:59:41,375 - INFO - exists: True
2025-04-27 02:59:41,397 - INFO - factorize_layer_kron_svd
2025-04-27 02:59:44,297 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:59:47,154 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 02:59:48,601 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 02:59:50,420 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 02:59:52,932 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.24.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_self_attn_v_proj.safetensors True
Layer: model.layers.24.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [3.9264322e-03 1.4345253e-05 8.7122116e-06 7.7657978e-06 6.5538288e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 03:00:51,462 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 03:00:51,463 - INFO - Replacing 'model.layers.24.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 03:00:51,465 - INFO - Compression finished. 
2025-04-27 03:01:11,511 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:25,  1.25s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.21s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.19s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.19s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.19s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.19s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.20s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.20s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.19s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.19s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.19s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 03:01:44,036 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 03:01:44,037 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 03:01:54,128 - INFO - ptb perplexity: 25.7500
2025-04-27 03:01:54,129 - INFO - Evaluation results:
2025-04-27 03:01:54,129 - INFO -   wikitext2: 6.9375
2025-04-27 03:01:54,129 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:14<00:29, 14.66s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:29<00:14, 14.66s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:39<00:00, 12.55s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:39<00:00, 13.12s/it]
2025-04-27 03:02:33,899 - INFO - Layer: model.layers.24.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 03:02:33,902 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_self_attn_o_proj.safetensors
2025-04-27 03:02:33,902 - INFO - exists: True
2025-04-27 03:02:33,911 - INFO - factorize_layer_kron_svd
2025-04-27 03:02:35,676 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:02:37,503 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:02:39,490 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 03:02:41,038 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 03:02:42,521 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 03:02:45,245 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 03:02:47,885 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:02:49,378 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:02:50,893 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 03:02:54,075 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 03:02:57,165 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 03:03:01,389 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.24.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_self_attn_o_proj.safetensors True
Layer: model.layers.24.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [6.6310076e-06 2.7686199e-06 2.6060300e-06 2.5201405e-06 2.4519159e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 03:04:17,003 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 03:04:17,003 - INFO - Replacing 'model.layers.24.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 03:04:17,005 - INFO - Compression finished. 
2025-04-27 03:04:28,759 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.20s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:19,  1.20s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:18,  1.20s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.19s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.19s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.19s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.19s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.19s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.19s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.19s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.20s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.20s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 03:04:58,871 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 03:04:58,871 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.20s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.20s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 03:06:12,168 - INFO - ptb perplexity: 26.2500
2025-04-27 03:06:12,168 - INFO - Evaluation results:
2025-04-27 03:06:12,168 - INFO -   wikitext2: 7.0000
2025-04-27 03:06:12,168 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:19<00:39, 19.50s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:40<00:20, 20.67s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:55<00:00, 17.93s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:55<00:00, 18.55s/it]
2025-04-27 03:07:08,271 - INFO - Layer: model.layers.24.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 03:07:08,275 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_mlp_gate_proj.safetensors
2025-04-27 03:07:08,275 - INFO - exists: True
2025-04-27 03:07:08,281 - INFO - factorize_layer_kron_svd
2025-04-27 03:07:12,063 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:07:15,277 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:07:18,508 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 03:07:21,864 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 03:07:25,004 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 03:07:27,375 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 03:07:29,764 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:07:34,169 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:07:39,062 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 03:07:42,200 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 03:07:44,797 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 03:07:55,775 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.24.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_mlp_gate_proj.safetensors True
Layer: model.layers.24.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [1.0848038e-05 5.9405497e-06 5.6468962e-06 5.4398588e-06 5.3999447e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 03:09:36,406 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 03:09:36,407 - INFO - Replacing 'model.layers.24.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 03:09:36,413 - INFO - Compression finished. 
2025-04-27 03:09:48,774 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.24s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:23,  1.22s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.20s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.19s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 03:10:21,351 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 03:10:21,351 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.17s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 03:10:31,308 - INFO - ptb perplexity: 25.7500
2025-04-27 03:10:31,308 - INFO - Evaluation results:
2025-04-27 03:10:31,308 - INFO -   wikitext2: 7.0625
2025-04-27 03:10:31,308 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:20<00:41, 20.96s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:42<00:21, 21.58s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:58<00:00, 18.59s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:58<00:00, 19.33s/it]
2025-04-27 03:11:30,072 - INFO - Layer: model.layers.24.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 03:11:30,076 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_mlp_up_proj.safetensors
2025-04-27 03:11:30,076 - INFO - exists: True
2025-04-27 03:11:30,105 - INFO - factorize_layer_kron_svd
2025-04-27 03:11:33,893 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:11:37,196 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:11:39,881 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 03:11:41,813 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 03:11:43,389 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 03:11:46,996 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 03:11:51,804 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:11:54,776 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:11:57,824 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 03:12:02,779 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 03:12:08,397 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 03:12:15,108 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.24.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_mlp_up_proj.safetensors True
Layer: model.layers.24.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [4.6520490e-06 4.4155945e-06 4.3086152e-06 4.1636677e-06 4.0883192e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 03:14:29,281 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 03:14:29,282 - INFO - Replacing 'model.layers.24.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 03:14:29,288 - INFO - Compression finished. 
2025-04-27 03:14:44,684 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.20s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.19s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.12s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 03:15:16,466 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 03:15:16,467 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.20s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 03:15:27,407 - INFO - ptb perplexity: 25.7500
2025-04-27 03:15:27,407 - INFO - Evaluation results:
2025-04-27 03:15:27,408 - INFO -   wikitext2: 7.0625
2025-04-27 03:15:27,408 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:21<00:42, 21.48s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:43<00:21, 21.55s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:57<00:00, 18.47s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:57<00:00, 19.29s/it]
2025-04-27 03:16:25,884 - INFO - Layer: model.layers.24.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 03:16:25,888 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_mlp_down_proj.safetensors
2025-04-27 03:16:25,888 - INFO - exists: True
2025-04-27 03:16:25,980 - INFO - factorize_layer_kron_svd
2025-04-27 03:16:31,984 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:16:34,970 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:16:39,204 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 03:16:43,643 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 03:16:46,623 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 03:16:56,096 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 03:16:59,598 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:17:01,156 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:17:03,516 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 03:17:05,096 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 03:17:06,741 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 03:17:08,637 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.24.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_24_mlp_down_proj.safetensors True
Layer: model.layers.24.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [5.5479163e-06 4.7517065e-06 4.1828225e-06 4.1455337e-06 4.0539248e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 03:19:30,151 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 03:19:30,151 - INFO - Replacing 'model.layers.24.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 03:19:30,156 - INFO - Compression finished. 
2025-04-27 03:19:39,216 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 03:20:08,940 - INFO - wikitext2 perplexity: 7.0938
2025-04-27 03:20:08,940 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9609375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 03:20:18,861 - INFO - ptb perplexity: 25.7500
2025-04-27 03:20:18,861 - INFO - Evaluation results:
2025-04-27 03:20:18,861 - INFO -   wikitext2: 7.0938
2025-04-27 03:20:18,861 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.43s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.31s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.70s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.14s/it]
2025-04-27 03:20:55,697 - INFO - Layer: model.layers.25.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 03:20:55,699 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_self_attn_q_proj.safetensors
2025-04-27 03:20:55,699 - INFO - exists: True
2025-04-27 03:20:55,723 - INFO - factorize_layer_kron_svd
2025-04-27 03:20:58,028 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:20:59,875 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:21:01,762 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 03:21:03,292 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:21:05,144 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.25.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_self_attn_q_proj.safetensors True
Layer: model.layers.25.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [4.3708067e-03 1.5627698e-05 1.0878799e-05 8.4382891e-06 7.5952244e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 03:21:49,688 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 03:21:49,689 - INFO - Replacing 'model.layers.25.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 03:21:49,691 - INFO - Compression finished. 
2025-04-27 03:21:59,704 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 03:22:29,942 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 03:22:29,942 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.18s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 03:22:39,719 - INFO - ptb perplexity: 25.7500
2025-04-27 03:22:39,719 - INFO - Evaluation results:
2025-04-27 03:22:39,719 - INFO -   wikitext2: 7.0000
2025-04-27 03:22:39,719 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.80s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:27<00:13, 13.88s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.74s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.31s/it]
2025-04-27 03:23:17,027 - INFO - Layer: model.layers.25.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 03:23:17,030 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_self_attn_k_proj.safetensors
2025-04-27 03:23:17,030 - INFO - exists: True
2025-04-27 03:23:17,050 - INFO - factorize_layer_kron_svd
2025-04-27 03:23:19,151 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:23:21,162 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 03:23:22,701 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:23:24,460 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.25.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_self_attn_k_proj.safetensors True
Layer: model.layers.25.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.5420940e-03 9.2317212e-05 9.5988307e-06 8.3629457e-06 6.2993668e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 03:24:07,107 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 03:24:07,107 - INFO - Replacing 'model.layers.25.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 03:24:07,109 - INFO - Compression finished. 
2025-04-27 03:24:17,169 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 03:24:47,073 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 03:24:47,074 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.18s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 03:24:56,907 - INFO - ptb perplexity: 25.7500
2025-04-27 03:24:56,907 - INFO - Evaluation results:
2025-04-27 03:24:56,907 - INFO -   wikitext2: 7.0000
2025-04-27 03:24:56,908 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.51s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.47s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.55s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.07s/it]
2025-04-27 03:25:33,526 - INFO - Layer: model.layers.25.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 03:25:33,529 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_self_attn_v_proj.safetensors
2025-04-27 03:25:33,529 - INFO - exists: True
2025-04-27 03:25:33,559 - INFO - factorize_layer_kron_svd
2025-04-27 03:25:35,434 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:25:37,251 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 03:25:38,713 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:25:40,403 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:25:42,165 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.25.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_self_attn_v_proj.safetensors True
Layer: model.layers.25.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [5.0888630e-04 3.8352286e-05 7.3461697e-06 5.9597046e-06 5.5316964e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 03:26:26,402 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 03:26:26,402 - INFO - Replacing 'model.layers.25.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 03:26:26,404 - INFO - Compression finished. 
2025-04-27 03:26:36,707 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.19s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 03:27:06,664 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 03:27:06,664 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.19s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 03:27:16,530 - INFO - ptb perplexity: 25.7500
2025-04-27 03:27:16,531 - INFO - Evaluation results:
2025-04-27 03:27:16,531 - INFO -   wikitext2: 7.0000
2025-04-27 03:27:16,531 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.07s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.25s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.66s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.07s/it]
2025-04-27 03:27:53,112 - INFO - Layer: model.layers.25.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 03:27:53,114 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_self_attn_o_proj.safetensors
2025-04-27 03:27:53,115 - INFO - exists: True
2025-04-27 03:27:53,124 - INFO - factorize_layer_kron_svd
2025-04-27 03:27:55,196 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:27:56,925 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:27:58,859 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 03:28:00,450 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:28:02,324 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.25.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_self_attn_o_proj.safetensors True
Layer: model.layers.25.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [4.6871588e-04 5.3153839e-05 9.8215614e-06 8.9253917e-06 7.2482790e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 03:29:24,302 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 03:29:24,303 - INFO - Replacing 'model.layers.25.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 03:29:24,305 - INFO - Compression finished. 
2025-04-27 03:29:34,700 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 03:30:04,256 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 03:30:04,256 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 03:30:14,188 - INFO - ptb perplexity: 25.7500
2025-04-27 03:30:14,188 - INFO - Evaluation results:
2025-04-27 03:30:14,188 - INFO -   wikitext2: 7.0000
2025-04-27 03:30:14,188 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:14<00:29, 14.52s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:29<00:14, 14.60s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:39<00:00, 12.74s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:39<00:00, 13.24s/it]
2025-04-27 03:30:54,302 - INFO - Layer: model.layers.25.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 03:30:54,304 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_mlp_gate_proj.safetensors
2025-04-27 03:30:54,304 - INFO - exists: True
2025-04-27 03:30:54,311 - INFO - factorize_layer_kron_svd
2025-04-27 03:30:56,532 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:30:58,811 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:31:02,083 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 03:31:05,201 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 03:31:08,411 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 03:31:11,038 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 03:31:14,868 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:31:19,565 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:31:23,004 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 03:31:26,612 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 03:31:29,305 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 03:31:33,658 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.25.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_mlp_gate_proj.safetensors True
Layer: model.layers.25.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [1.0785532e-05 6.0120674e-06 5.5476030e-06 5.4213779e-06 5.2254745e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 03:33:39,744 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 03:33:39,744 - INFO - Replacing 'model.layers.25.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 03:33:39,749 - INFO - Compression finished. 
2025-04-27 03:33:54,699 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.19s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.19s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.20s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.20s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.20s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.20s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.20s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.20s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:06,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.20s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 03:34:25,052 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 03:34:25,052 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.20s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 03:34:35,373 - INFO - ptb perplexity: 25.7500
2025-04-27 03:34:35,373 - INFO - Evaluation results:
2025-04-27 03:34:35,373 - INFO -   wikitext2: 7.0625
2025-04-27 03:34:35,373 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:15<00:30, 15.18s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:32<00:16, 16.19s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:42<00:00, 13.47s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:42<00:00, 14.10s/it]
2025-04-27 03:35:18,185 - INFO - Layer: model.layers.25.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 03:35:18,188 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_mlp_up_proj.safetensors
2025-04-27 03:35:18,188 - INFO - exists: True
2025-04-27 03:35:18,268 - INFO - factorize_layer_kron_svd
2025-04-27 03:35:20,583 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:35:22,387 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:35:24,351 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 03:35:27,361 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:35:38,184 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.25.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_mlp_up_proj.safetensors True
Layer: model.layers.25.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [5.2369884e-03 1.2808485e-05 1.0910483e-05 1.0035876e-05 9.8339870e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 03:37:29,165 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 03:37:29,165 - INFO - Replacing 'model.layers.25.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 03:37:29,172 - INFO - Compression finished. 
2025-04-27 03:37:43,989 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.20s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.19s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.19s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.19s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 03:38:14,370 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 03:38:14,370 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:06,  1.23s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.22s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 03:38:25,010 - INFO - ptb perplexity: 25.7500
2025-04-27 03:38:25,011 - INFO - Evaluation results:
2025-04-27 03:38:25,011 - INFO -   wikitext2: 7.0625
2025-04-27 03:38:25,011 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:20<00:41, 20.92s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:41<00:20, 20.78s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:55<00:00, 17.77s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:55<00:00, 18.60s/it]
2025-04-27 03:39:21,373 - INFO - Layer: model.layers.25.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 03:39:21,377 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_mlp_down_proj.safetensors
2025-04-27 03:39:21,377 - INFO - exists: True
2025-04-27 03:39:21,401 - INFO - factorize_layer_kron_svd
2025-04-27 03:39:26,969 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:39:33,964 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:39:44,563 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 03:39:46,767 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:39:48,908 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:39:52,766 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.25.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_25_mlp_down_proj.safetensors True
Layer: model.layers.25.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [8.7665049e-03 2.1507645e-04 4.5935696e-05 3.7813756e-05 3.4908993e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 03:42:05,973 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 03:42:05,975 - INFO - Replacing 'model.layers.25.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 03:42:05,981 - INFO - Compression finished. 
2025-04-27 03:42:15,194 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.19s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.19s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.19s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 03:42:45,567 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 03:42:45,567 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.26s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:06,  1.22s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:06<00:02,  1.20s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.19s/it]
2025-04-27 03:42:56,407 - INFO - ptb perplexity: 25.7500
2025-04-27 03:42:56,407 - INFO - Evaluation results:
2025-04-27 03:42:56,407 - INFO -   wikitext2: 7.0625
2025-04-27 03:42:56,407 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:20<00:41, 20.80s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:42<00:21, 21.05s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 17.92s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 18.74s/it]
2025-04-27 03:43:53,171 - INFO - Layer: model.layers.26.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 03:43:53,176 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_self_attn_q_proj.safetensors
2025-04-27 03:43:53,176 - INFO - exists: True
2025-04-27 03:43:53,270 - INFO - factorize_layer_kron_svd
2025-04-27 03:43:55,716 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:43:59,210 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:44:03,198 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 03:44:04,785 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:44:07,192 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:44:08,871 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.26.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_self_attn_q_proj.safetensors True
Layer: model.layers.26.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.9605858e-02 1.6414824e-05 8.0549253e-06 7.5884514e-06 5.7002399e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 03:44:57,082 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 03:44:57,082 - INFO - Replacing 'model.layers.26.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 03:44:57,085 - INFO - Compression finished. 
2025-04-27 03:45:07,493 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:19,  1.20s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.20s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.20s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.20s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.20s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.20s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.20s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.20s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.20s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.20s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.20s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 03:45:38,472 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 03:45:38,472 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.19s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 03:45:48,911 - INFO - ptb perplexity: 25.7500
2025-04-27 03:45:48,911 - INFO - Evaluation results:
2025-04-27 03:45:48,911 - INFO -   wikitext2: 7.0000
2025-04-27 03:45:48,911 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:21<00:42, 21.49s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:42<00:21, 21.31s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:51<00:00, 15.55s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:51<00:00, 17.12s/it]
2025-04-27 03:46:40,824 - INFO - Layer: model.layers.26.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 03:46:40,827 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_self_attn_k_proj.safetensors
2025-04-27 03:46:40,827 - INFO - exists: True
2025-04-27 03:46:40,846 - INFO - factorize_layer_kron_svd
2025-04-27 03:46:43,382 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:46:45,102 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:46:48,211 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 03:46:51,503 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:46:55,225 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:46:57,172 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.26.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_self_attn_k_proj.safetensors True
Layer: model.layers.26.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [3.9891310e-02 1.5776022e-05 7.6437700e-06 5.6300814e-06 4.4077228e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 03:47:52,693 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 03:47:52,694 - INFO - Replacing 'model.layers.26.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 03:47:52,697 - INFO - Compression finished. 
2025-04-27 03:48:06,788 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.24s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.20s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.19s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.19s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.20s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.20s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 03:48:36,971 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 03:48:36,971 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 03:48:47,309 - INFO - ptb perplexity: 25.7500
2025-04-27 03:48:47,309 - INFO - Evaluation results:
2025-04-27 03:48:47,309 - INFO -   wikitext2: 7.0000
2025-04-27 03:48:47,309 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:19<00:39, 19.94s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:37<00:18, 18.49s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:47<00:00, 14.52s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:47<00:00, 15.74s/it]
2025-04-27 03:49:35,567 - INFO - Layer: model.layers.26.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 03:49:35,571 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_self_attn_v_proj.safetensors
2025-04-27 03:49:35,571 - INFO - exists: True
2025-04-27 03:49:35,582 - INFO - factorize_layer_kron_svd
2025-04-27 03:49:39,188 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:49:41,044 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 03:49:42,562 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:49:44,437 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:49:46,338 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.26.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_self_attn_v_proj.safetensors True
Layer: model.layers.26.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [5.9758541e-03 1.9324034e-05 9.3038707e-06 8.1034304e-06 6.7713663e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 03:50:45,576 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 03:50:45,576 - INFO - Replacing 'model.layers.26.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 03:50:45,579 - INFO - Compression finished. 
2025-04-27 03:51:03,085 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:19,  1.20s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.20s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.20s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.20s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.20s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.20s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.19s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.21s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:18<00:07,  1.23s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:06,  1.21s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 03:51:34,372 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 03:51:34,372 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.19s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 03:51:44,267 - INFO - ptb perplexity: 25.3750
2025-04-27 03:51:44,267 - INFO - Evaluation results:
2025-04-27 03:51:44,268 - INFO -   wikitext2: 6.9375
2025-04-27 03:51:44,268 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:16<00:33, 16.83s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:32<00:15, 15.86s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:42<00:00, 13.27s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:42<00:00, 14.06s/it]
2025-04-27 03:52:26,972 - INFO - Layer: model.layers.26.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 03:52:26,976 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_self_attn_o_proj.safetensors
2025-04-27 03:52:26,976 - INFO - exists: True
2025-04-27 03:52:26,996 - INFO - factorize_layer_kron_svd
2025-04-27 03:52:30,896 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:52:34,486 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:52:38,399 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 03:52:41,497 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:52:45,287 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.26.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_self_attn_o_proj.safetensors True
Layer: model.layers.26.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [9.7393105e-03 3.5570287e-05 1.1101330e-05 8.3519908e-06 6.8651966e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 03:53:48,393 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 03:53:48,394 - INFO - Replacing 'model.layers.26.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 03:53:48,396 - INFO - Compression finished. 
2025-04-27 03:53:59,643 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:19,  1.20s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.19s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.19s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.19s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.19s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.19s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.20s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.20s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.20s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 03:54:29,871 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 03:54:29,871 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.20s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.20s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 03:54:40,395 - INFO - ptb perplexity: 25.3750
2025-04-27 03:54:40,395 - INFO - Evaluation results:
2025-04-27 03:54:40,395 - INFO -   wikitext2: 6.9375
2025-04-27 03:54:40,395 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:17<00:35, 17.59s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:39<00:19, 19.99s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:53<00:00, 17.51s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:53<00:00, 17.94s/it]
2025-04-27 03:55:34,602 - INFO - Layer: model.layers.26.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 03:55:34,605 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_mlp_gate_proj.safetensors
2025-04-27 03:55:34,605 - INFO - exists: True
2025-04-27 03:55:34,613 - INFO - factorize_layer_kron_svd
2025-04-27 03:55:36,605 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:55:38,848 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 03:55:40,668 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 03:55:46,284 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:55:54,203 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.26.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_mlp_gate_proj.safetensors True
Layer: model.layers.26.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [3.5354062e-03 1.2539586e-05 5.3919930e-06 4.6146652e-06 4.4492190e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 03:57:36,261 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 03:57:36,261 - INFO - Replacing 'model.layers.26.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 03:57:36,268 - INFO - Compression finished. 
2025-04-27 03:57:51,488 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.20s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.20s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:19,  1.19s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.19s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.19s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 03:58:24,867 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 03:58:24,867 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.20s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.20s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:06<00:02,  1.20s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.18s/it]
2025-04-27 03:58:35,308 - INFO - ptb perplexity: 26.2500
2025-04-27 03:58:35,309 - INFO - Evaluation results:
2025-04-27 03:58:35,309 - INFO -   wikitext2: 7.0625
2025-04-27 03:58:35,309 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:20<00:41, 20.60s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:41<00:21, 21.02s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 18.17s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 18.90s/it]
2025-04-27 03:59:32,573 - INFO - Layer: model.layers.26.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 03:59:32,576 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_mlp_up_proj.safetensors
2025-04-27 03:59:32,576 - INFO - exists: True
2025-04-27 03:59:32,596 - INFO - factorize_layer_kron_svd
2025-04-27 03:59:36,508 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:59:40,665 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 03:59:45,680 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 03:59:54,794 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.26.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_mlp_up_proj.safetensors True
Layer: model.layers.26.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [5.6883384e-04 1.2054178e-04 1.2884599e-05 1.1027682e-05 9.3955405e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 04:01:45,371 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 04:01:45,371 - INFO - Replacing 'model.layers.26.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 04:01:45,378 - INFO - Compression finished. 
2025-04-27 04:02:00,583 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.20s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.20s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.20s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:19,  1.19s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.19s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 04:02:32,864 - INFO - wikitext2 perplexity: 7.0938
2025-04-27 04:02:32,865 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9609375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.25s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:06,  1.22s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.20s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.18s/it]
2025-04-27 04:02:42,966 - INFO - ptb perplexity: 25.7500
2025-04-27 04:02:42,967 - INFO - Evaluation results:
2025-04-27 04:02:42,967 - INFO -   wikitext2: 7.0938
2025-04-27 04:02:42,967 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:20<00:41, 20.71s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:42<00:21, 21.17s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:57<00:00, 18.28s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:57<00:00, 19.01s/it]
2025-04-27 04:03:40,685 - INFO - Layer: model.layers.26.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 04:03:40,696 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_mlp_down_proj.safetensors
2025-04-27 04:03:40,696 - INFO - exists: True
2025-04-27 04:03:40,866 - INFO - factorize_layer_kron_svd
2025-04-27 04:03:46,603 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:03:52,936 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:04:01,605 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 04:04:03,832 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:04:05,485 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:04:07,777 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.26.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_26_mlp_down_proj.safetensors True
Layer: model.layers.26.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [4.1444181e-03 7.6422427e-04 4.0036848e-05 3.7765723e-05 3.1555592e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 04:06:44,876 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 04:06:44,876 - INFO - Replacing 'model.layers.26.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 04:06:44,884 - INFO - Compression finished. 
2025-04-27 04:06:57,441 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.20s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.19s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.19s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.20s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 04:07:28,268 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 04:07:28,268 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.19s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.20s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.20s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.20s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 04:07:38,608 - INFO - ptb perplexity: 25.7500
2025-04-27 04:07:38,608 - INFO - Evaluation results:
2025-04-27 04:07:38,608 - INFO -   wikitext2: 7.0625
2025-04-27 04:07:38,608 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:20<00:41, 20.79s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:41<00:20, 21.00s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 17.98s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 18.77s/it]
2025-04-27 04:08:35,573 - INFO - Layer: model.layers.27.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 04:08:35,579 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_self_attn_q_proj.safetensors
2025-04-27 04:08:35,579 - INFO - exists: True
2025-04-27 04:08:35,671 - INFO - factorize_layer_kron_svd
2025-04-27 04:08:40,006 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:08:43,663 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:08:47,492 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 04:08:50,216 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:08:52,326 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:08:55,900 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.27.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_self_attn_q_proj.safetensors True
Layer: model.layers.27.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [3.1449087e-02 1.7293913e-05 1.0841605e-05 1.0305326e-05 7.7381810e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 04:09:52,798 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 04:09:52,798 - INFO - Replacing 'model.layers.27.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 04:09:52,800 - INFO - Compression finished. 
2025-04-27 04:10:04,372 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.20s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.20s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:19,  1.20s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.20s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.20s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.20s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.20s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.20s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.20s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.20s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.20s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.20s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.20s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.19s/it]
2025-04-27 04:10:37,271 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 04:10:37,271 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.19s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.18s/it]
2025-04-27 04:10:47,967 - INFO - ptb perplexity: 25.3750
2025-04-27 04:10:47,967 - INFO - Evaluation results:
2025-04-27 04:10:47,967 - INFO -   wikitext2: 6.9375
2025-04-27 04:10:47,967 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:21<00:42, 21.09s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:39<00:19, 19.73s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:51<00:00, 16.10s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:51<00:00, 17.22s/it]
2025-04-27 04:11:40,172 - INFO - Layer: model.layers.27.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 04:11:40,176 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_self_attn_k_proj.safetensors
2025-04-27 04:11:40,176 - INFO - exists: True
2025-04-27 04:11:40,187 - INFO - factorize_layer_kron_svd
2025-04-27 04:11:42,663 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:11:44,334 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:11:46,477 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 04:11:47,988 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:11:50,563 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.27.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_self_attn_k_proj.safetensors True
Layer: model.layers.27.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [4.4964168e-02 2.2320717e-05 6.6194466e-06 5.9166182e-06 5.3742956e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 04:12:57,577 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 04:12:57,578 - INFO - Replacing 'model.layers.27.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 04:12:57,581 - INFO - Compression finished. 
2025-04-27 04:13:14,903 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:19,  1.20s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.20s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.20s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.20s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.20s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.20s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.19s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.19s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.19s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.19s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 04:13:47,829 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 04:13:47,829 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.18s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 04:13:57,809 - INFO - ptb perplexity: 25.3750
2025-04-27 04:13:57,809 - INFO - Evaluation results:
2025-04-27 04:13:57,809 - INFO -   wikitext2: 6.9375
2025-04-27 04:13:57,809 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:16<00:32, 16.35s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:33<00:16, 16.93s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:43<00:00, 13.58s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:43<00:00, 14.42s/it]
2025-04-27 04:14:41,527 - INFO - Layer: model.layers.27.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 04:14:41,528 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_self_attn_v_proj.safetensors
2025-04-27 04:14:41,528 - INFO - exists: True
2025-04-27 04:14:41,540 - INFO - factorize_layer_kron_svd
2025-04-27 04:14:45,595 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:14:49,290 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 04:14:52,472 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:14:56,012 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:14:59,903 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.27.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_self_attn_v_proj.safetensors True
Layer: model.layers.27.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.9446029e-03 1.0470939e-05 5.8570222e-06 4.9564360e-06 4.3207142e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 04:16:04,892 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 04:16:04,892 - INFO - Replacing 'model.layers.27.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 04:16:04,894 - INFO - Compression finished. 
2025-04-27 04:16:10,946 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:19,  1.19s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.19s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.19s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.19s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.19s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.20s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.20s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.20s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.20s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 04:16:41,470 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 04:16:41,471 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 04:16:51,909 - INFO - ptb perplexity: 25.7500
2025-04-27 04:16:51,909 - INFO - Evaluation results:
2025-04-27 04:16:51,910 - INFO -   wikitext2: 6.9375
2025-04-27 04:16:51,910 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:20<00:41, 20.77s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:42<00:21, 21.17s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 18.21s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 18.97s/it]
2025-04-27 04:17:49,373 - INFO - Layer: model.layers.27.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 04:17:49,378 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_self_attn_o_proj.safetensors
2025-04-27 04:17:49,379 - INFO - exists: True
2025-04-27 04:17:49,401 - INFO - factorize_layer_kron_svd
2025-04-27 04:17:53,513 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:17:57,379 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:17:59,567 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 04:18:02,384 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:18:06,297 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.27.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_self_attn_o_proj.safetensors True
Layer: model.layers.27.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [5.9311185e-04 7.7654811e-05 8.7173285e-06 6.6445004e-06 5.8701989e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 04:19:00,605 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 04:19:00,606 - INFO - Replacing 'model.layers.27.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 04:19:00,610 - INFO - Compression finished. 
2025-04-27 04:19:10,331 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:25,  1.26s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:23,  1.22s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.21s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.21s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:06<00:19,  1.20s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:18,  1.20s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.20s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.20s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.20s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:12<00:13,  1.20s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:12,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.20s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.20s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.20s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:18<00:07,  1.20s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:06,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.20s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:24<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.19s/it]
2025-04-27 04:19:42,170 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 04:19:42,170 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.20s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.20s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.18s/it]
2025-04-27 04:19:52,211 - INFO - ptb perplexity: 25.7500
2025-04-27 04:19:52,211 - INFO - Evaluation results:
2025-04-27 04:19:52,211 - INFO -   wikitext2: 6.9375
2025-04-27 04:19:52,211 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:15<00:30, 15.04s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:30<00:15, 15.53s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:40<00:00, 13.02s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:40<00:00, 13.65s/it]
2025-04-27 04:20:33,718 - INFO - Layer: model.layers.27.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 04:20:33,723 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_mlp_gate_proj.safetensors
2025-04-27 04:20:33,723 - INFO - exists: True
2025-04-27 04:20:33,733 - INFO - factorize_layer_kron_svd
2025-04-27 04:20:36,402 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:20:40,895 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:20:44,768 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 04:20:47,803 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:20:52,838 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.27.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_mlp_gate_proj.safetensors True
Layer: model.layers.27.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [8.5178309e-04 1.7080700e-04 1.5016245e-05 1.2949634e-05 1.1322722e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 04:23:30,773 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 04:23:30,773 - INFO - Replacing 'model.layers.27.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 04:23:30,783 - INFO - Compression finished. 
2025-04-27 04:23:41,650 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.20s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.19s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.19s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.19s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.19s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 04:24:11,767 - INFO - wikitext2 perplexity: 7.0938
2025-04-27 04:24:11,768 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9609375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.20s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.20s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.18s/it]
2025-04-27 04:24:22,708 - INFO - ptb perplexity: 26.2500
2025-04-27 04:24:22,708 - INFO - Evaluation results:
2025-04-27 04:24:22,708 - INFO -   wikitext2: 7.0938
2025-04-27 04:24:22,708 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:21<00:42, 21.12s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:41<00:20, 20.86s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 18.10s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:56<00:00, 18.87s/it]
2025-04-27 04:25:20,003 - INFO - Layer: model.layers.27.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 04:25:20,009 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_mlp_up_proj.safetensors
2025-04-27 04:25:20,009 - INFO - exists: True
2025-04-27 04:25:20,097 - INFO - factorize_layer_kron_svd
2025-04-27 04:25:24,010 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:25:26,666 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:25:28,557 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 04:25:31,680 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 04:25:34,907 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 04:25:37,564 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 04:25:40,650 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:25:44,301 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:25:49,793 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 04:25:53,611 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 04:25:56,875 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 04:26:02,892 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.27.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_mlp_up_proj.safetensors True
Layer: model.layers.27.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [6.8934842e-06 4.5069078e-06 4.2314714e-06 4.1367944e-06 4.0144014e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 04:28:26,850 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 04:28:26,851 - INFO - Replacing 'model.layers.27.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 04:28:26,857 - INFO - Compression finished. 
2025-04-27 04:28:37,087 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.19s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.19s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.20s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.20s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.20s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.20s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.20s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.20s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.20s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:19<00:05,  1.20s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.20s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.20s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.20s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.20s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.11s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.18s/it]
2025-04-27 04:29:07,867 - INFO - wikitext2 perplexity: 7.1562
2025-04-27 04:29:07,868 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.96875
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 04:29:18,609 - INFO - ptb perplexity: 26.2500
2025-04-27 04:29:18,609 - INFO - Evaluation results:
2025-04-27 04:29:18,609 - INFO -   wikitext2: 7.1562
2025-04-27 04:29:18,609 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:20<00:41, 20.90s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:42<00:21, 21.19s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:57<00:00, 18.29s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:57<00:00, 19.04s/it]
2025-04-27 04:30:16,572 - INFO - Layer: model.layers.27.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 04:30:16,576 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_mlp_down_proj.safetensors
2025-04-27 04:30:16,576 - INFO - exists: True
2025-04-27 04:30:16,671 - INFO - factorize_layer_kron_svd
2025-04-27 04:30:22,489 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:30:27,841 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:30:37,207 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 04:30:39,935 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:30:41,554 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:30:44,598 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.27.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_27_mlp_down_proj.safetensors True
Layer: model.layers.27.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [4.3249605e-03 9.9447533e-04 4.9234852e-05 3.5841313e-05 3.4881272e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 04:32:53,666 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 04:32:53,667 - INFO - Replacing 'model.layers.27.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 04:32:53,673 - INFO - Compression finished. 
2025-04-27 04:33:07,699 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.19s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 04:33:38,252 - INFO - wikitext2 perplexity: 7.0625
2025-04-27 04:33:38,252 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.953125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.25s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:06,  1.21s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.21s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.21s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:06<00:02,  1.21s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.20s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.15s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.18s/it]
2025-04-27 04:33:48,408 - INFO - ptb perplexity: 26.2500
2025-04-27 04:33:48,408 - INFO - Evaluation results:
2025-04-27 04:33:48,408 - INFO -   wikitext2: 7.0625
2025-04-27 04:33:48,408 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:20<00:41, 20.52s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:41<00:20, 20.85s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:55<00:00, 17.90s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:55<00:00, 18.66s/it]
2025-04-27 04:34:44,871 - INFO - Layer: model.layers.28.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 04:34:44,876 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_self_attn_q_proj.safetensors
2025-04-27 04:34:44,876 - INFO - exists: True
2025-04-27 04:34:45,000 - INFO - factorize_layer_kron_svd
2025-04-27 04:34:49,282 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:34:52,988 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:34:56,536 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 04:34:58,489 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:35:00,649 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:35:04,492 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.28.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_self_attn_q_proj.safetensors True
Layer: model.layers.28.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [7.7257529e-02 2.7300872e-05 1.5574698e-05 1.3328204e-05 1.0336477e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 04:36:00,705 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 04:36:00,705 - INFO - Replacing 'model.layers.28.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 04:36:00,709 - INFO - Compression finished. 
2025-04-27 04:36:10,369 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.22s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 04:36:40,214 - INFO - wikitext2 perplexity: 6.8438
2025-04-27 04:36:40,215 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.921875
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.18s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 04:36:50,026 - INFO - ptb perplexity: 25.3750
2025-04-27 04:36:50,027 - INFO - Evaluation results:
2025-04-27 04:36:50,027 - INFO -   wikitext2: 6.8438
2025-04-27 04:36:50,027 - INFO -   ptb: 25.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.234375
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.48s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.18s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.42s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.93s/it]
2025-04-27 04:37:26,324 - INFO - Layer: model.layers.28.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 04:37:26,326 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_self_attn_k_proj.safetensors
2025-04-27 04:37:26,326 - INFO - exists: True
2025-04-27 04:37:26,335 - INFO - factorize_layer_kron_svd
2025-04-27 04:37:28,182 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:37:29,676 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:37:31,192 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 04:37:32,678 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 04:37:34,183 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 04:37:35,947 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 04:37:37,475 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:37:39,092 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:37:40,593 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 04:37:42,112 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 04:37:43,589 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 04:37:45,374 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.28.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_self_attn_k_proj.safetensors True
Layer: model.layers.28.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.3403688e-05 6.0787293e-06 5.6532840e-06 5.4129196e-06 5.2258588e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 04:38:29,534 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 04:38:29,535 - INFO - Replacing 'model.layers.28.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 04:38:29,539 - INFO - Compression finished. 
2025-04-27 04:38:41,300 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 04:39:11,152 - INFO - wikitext2 perplexity: 6.7812
2025-04-27 04:39:11,152 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9140625
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.18s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 04:39:21,003 - INFO - ptb perplexity: 25.0000
2025-04-27 04:39:21,004 - INFO - Evaluation results:
2025-04-27 04:39:21,004 - INFO -   wikitext2: 6.7812
2025-04-27 04:39:21,004 - INFO -   ptb: 25.0000
nlls.shape torch.Size([16376])
Mean NLL: 3.21875
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.60s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:27<00:13, 13.71s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.81s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.31s/it]
2025-04-27 04:39:58,379 - INFO - Layer: model.layers.28.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 04:39:58,382 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_self_attn_v_proj.safetensors
2025-04-27 04:39:58,382 - INFO - exists: True
2025-04-27 04:39:58,405 - INFO - factorize_layer_kron_svd
2025-04-27 04:40:00,223 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:40:02,129 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 04:40:03,570 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:40:05,220 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:40:07,149 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.28.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_self_attn_v_proj.safetensors True
Layer: model.layers.28.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [4.3790042e-03 3.8969152e-05 6.8497079e-06 5.9434851e-06 5.2697724e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 04:40:52,620 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 04:40:52,620 - INFO - Replacing 'model.layers.28.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 04:40:52,623 - INFO - Compression finished. 
2025-04-27 04:41:00,520 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.19s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 04:41:30,319 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 04:41:30,319 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.17s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 04:41:40,098 - INFO - ptb perplexity: 25.7500
2025-04-27 04:41:40,098 - INFO - Evaluation results:
2025-04-27 04:41:40,098 - INFO -   wikitext2: 7.0000
2025-04-27 04:41:40,098 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.52s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.48s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.41s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.98s/it]
2025-04-27 04:42:16,451 - INFO - Layer: model.layers.28.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 04:42:16,454 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_self_attn_o_proj.safetensors
2025-04-27 04:42:16,455 - INFO - exists: True
2025-04-27 04:42:16,467 - INFO - factorize_layer_kron_svd
2025-04-27 04:42:18,351 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:42:20,299 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:42:22,063 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 04:42:23,632 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:42:25,339 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.28.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_self_attn_o_proj.safetensors True
Layer: model.layers.28.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [9.29757953e-03 1.58346011e-05 1.33602125e-05 8.97536120e-06
 7.57745966e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 04:43:14,723 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 04:43:14,724 - INFO - Replacing 'model.layers.28.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 04:43:14,727 - INFO - Compression finished. 
2025-04-27 04:43:20,558 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 04:43:51,055 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 04:43:51,055 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.19s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 04:44:01,036 - INFO - ptb perplexity: 25.7500
2025-04-27 04:44:01,036 - INFO - Evaluation results:
2025-04-27 04:44:01,036 - INFO -   wikitext2: 7.0000
2025-04-27 04:44:01,036 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:12<00:25, 12.88s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:25<00:12, 12.97s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:34<00:00, 11.06s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:34<00:00, 11.57s/it]
2025-04-27 04:44:36,109 - INFO - Layer: model.layers.28.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 04:44:36,112 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_mlp_gate_proj.safetensors
2025-04-27 04:44:36,112 - INFO - exists: True
2025-04-27 04:44:36,119 - INFO - factorize_layer_kron_svd
2025-04-27 04:44:38,325 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:44:39,993 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:44:41,775 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 04:44:44,323 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:44:49,420 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.28.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_mlp_gate_proj.safetensors True
Layer: model.layers.28.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [2.48785485e-02 2.44410057e-05 1.47788587e-05 1.22457295e-05
 1.07915093e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 04:46:20,251 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 04:46:20,252 - INFO - Replacing 'model.layers.28.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 04:46:20,259 - INFO - Compression finished. 
2025-04-27 04:46:30,838 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 04:47:01,484 - INFO - wikitext2 perplexity: 7.2188
2025-04-27 04:47:01,484 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9765625
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.17s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 04:47:11,284 - INFO - ptb perplexity: 26.2500
2025-04-27 04:47:11,284 - INFO - Evaluation results:
2025-04-27 04:47:11,284 - INFO -   wikitext2: 7.2188
2025-04-27 04:47:11,284 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.02s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.39s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.92s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.28s/it]
2025-04-27 04:47:48,511 - INFO - Layer: model.layers.28.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 04:47:48,514 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_mlp_up_proj.safetensors
2025-04-27 04:47:48,514 - INFO - exists: True
2025-04-27 04:47:48,549 - INFO - factorize_layer_kron_svd
2025-04-27 04:47:50,362 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:47:51,897 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:47:53,368 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 04:47:54,825 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 04:47:56,313 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 04:47:58,058 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 04:48:00,467 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:48:03,041 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:48:05,526 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 04:48:08,280 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 04:48:10,776 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 04:48:15,852 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.28.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_mlp_up_proj.safetensors True
Layer: model.layers.28.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [8.9290443e-06 4.8989136e-06 4.5310157e-06 4.3148771e-06 4.1740809e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 04:49:34,352 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 04:49:34,353 - INFO - Replacing 'model.layers.28.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 04:49:34,359 - INFO - Compression finished. 
2025-04-27 04:49:44,244 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 04:50:14,241 - INFO - wikitext2 perplexity: 7.3750
2025-04-27 04:50:14,241 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 2.0
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.19s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 04:50:24,569 - INFO - ptb perplexity: 26.6250
2025-04-27 04:50:24,571 - INFO - Evaluation results:
2025-04-27 04:50:24,571 - INFO -   wikitext2: 7.3750
2025-04-27 04:50:24,571 - INFO -   ptb: 26.6250
nlls.shape torch.Size([16376])
Mean NLL: 3.28125
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.60s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.38s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.63s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.12s/it]
2025-04-27 04:51:01,324 - INFO - Layer: model.layers.28.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 04:51:01,327 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_mlp_down_proj.safetensors
2025-04-27 04:51:01,327 - INFO - exists: True
2025-04-27 04:51:01,367 - INFO - factorize_layer_kron_svd
2025-04-27 04:51:03,827 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:51:06,539 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:51:09,077 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 04:51:11,557 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 04:51:14,086 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 04:51:19,485 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 04:51:21,182 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:51:22,649 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:51:24,134 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 04:51:25,648 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 04:51:27,094 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 04:51:28,862 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.28.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_28_mlp_down_proj.safetensors True
Layer: model.layers.28.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [4.8968691e-06 4.8387760e-06 4.7654949e-06 4.6622795e-06 4.4943499e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 04:53:09,462 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 04:53:09,462 - INFO - Replacing 'model.layers.28.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 04:53:09,469 - INFO - Compression finished. 
2025-04-27 04:53:17,183 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.18s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:19,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 04:53:47,070 - INFO - wikitext2 perplexity: 7.3750
2025-04-27 04:53:47,070 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 2.0
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 04:54:02,876 - INFO - ptb perplexity: 26.2500
2025-04-27 04:54:02,876 - INFO - Evaluation results:
2025-04-27 04:54:02,876 - INFO -   wikitext2: 7.3750
2025-04-27 04:54:02,876 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.34s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.46s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.71s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.17s/it]
2025-04-27 04:54:39,781 - INFO - Layer: model.layers.29.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 04:54:39,785 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_self_attn_q_proj.safetensors
2025-04-27 04:54:39,785 - INFO - exists: True
2025-04-27 04:54:39,851 - INFO - factorize_layer_kron_svd
2025-04-27 04:54:41,719 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:54:43,448 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:54:45,247 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 04:54:46,837 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:54:48,687 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:54:50,768 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.29.self_attn.q_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_self_attn_q_proj.safetensors True
Layer: model.layers.29.self_attn.q_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [1.3079672e-02 6.6411179e-05 1.8837438e-05 1.0730346e-05 9.5193182e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 04:55:34,007 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 04:55:34,007 - INFO - Replacing 'model.layers.29.self_attn.q_proj' (attribute 'q_proj' within parent LlamaAttention)
2025-04-27 04:55:34,010 - INFO - Compression finished. 
2025-04-27 04:55:41,991 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 04:56:12,015 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 04:56:12,015 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.18s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 04:56:21,868 - INFO - ptb perplexity: 25.7500
2025-04-27 04:56:21,869 - INFO - Evaluation results:
2025-04-27 04:56:21,869 - INFO -   wikitext2: 6.9375
2025-04-27 04:56:21,869 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.52s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:27<00:13, 13.54s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.59s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.11s/it]
2025-04-27 04:56:59,118 - INFO - Layer: model.layers.29.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 04:56:59,121 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_self_attn_k_proj.safetensors
2025-04-27 04:56:59,122 - INFO - exists: True
2025-04-27 04:56:59,172 - INFO - factorize_layer_kron_svd
2025-04-27 04:57:02,488 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:57:04,124 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:57:06,085 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 04:57:07,677 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:57:09,568 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.29.self_attn.k_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_self_attn_k_proj.safetensors True
Layer: model.layers.29.self_attn.k_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [4.0633701e-02 6.4269574e-05 1.3669864e-05 7.6451261e-06 6.8974796e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 04:57:55,809 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 04:57:55,810 - INFO - Replacing 'model.layers.29.self_attn.k_proj' (attribute 'k_proj' within parent LlamaAttention)
2025-04-27 04:57:55,813 - INFO - Compression finished. 
2025-04-27 04:58:10,049 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.20s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.20s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.19s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.19s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.19s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.19s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.19s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.19s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.19s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.19s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.19s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 04:58:40,433 - INFO - wikitext2 perplexity: 6.9375
2025-04-27 04:58:40,434 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 04:58:50,295 - INFO - ptb perplexity: 25.7500
2025-04-27 04:58:50,295 - INFO - Evaluation results:
2025-04-27 04:58:50,295 - INFO -   wikitext2: 6.9375
2025-04-27 04:58:50,295 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.24s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.42s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.84s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.25s/it]
2025-04-27 04:59:27,504 - INFO - Layer: model.layers.29.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 04:59:27,508 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_self_attn_v_proj.safetensors
2025-04-27 04:59:27,508 - INFO - exists: True
2025-04-27 04:59:27,549 - INFO - factorize_layer_kron_svd
2025-04-27 04:59:29,347 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:59:31,065 - INFO -   Factor is positive definite (alpha=1.00e-04)
2025-04-27 04:59:32,485 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 04:59:34,235 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 04:59:36,032 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.29.self_attn.v_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_self_attn_v_proj.safetensors True
Layer: model.layers.29.self_attn.v_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [2.0035941e-03 9.6462361e-05 8.6782638e-06 8.5936981e-06 6.9090765e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 05:00:23,897 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 05:00:23,898 - INFO - Replacing 'model.layers.29.self_attn.v_proj' (attribute 'v_proj' within parent LlamaAttention)
2025-04-27 05:00:23,901 - INFO - Compression finished. 
2025-04-27 05:00:38,053 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.21s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.19s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.19s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.19s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 05:01:08,163 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 05:01:08,163 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.19s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.19s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.19s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 05:01:18,395 - INFO - ptb perplexity: 25.7500
2025-04-27 05:01:18,395 - INFO - Evaluation results:
2025-04-27 05:01:18,395 - INFO -   wikitext2: 7.0000
2025-04-27 05:01:18,395 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.04s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:25<00:12, 12.95s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.26s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.73s/it]
2025-04-27 05:01:54,005 - INFO - Layer: model.layers.29.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
2025-04-27 05:01:54,009 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_self_attn_o_proj.safetensors
2025-04-27 05:01:54,009 - INFO - exists: True
2025-04-27 05:01:54,018 - INFO - factorize_layer_kron_svd
2025-04-27 05:01:55,707 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 05:01:57,187 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 05:01:58,740 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 05:02:00,277 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 05:02:01,769 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 05:02:03,432 - INFO -   Factor is positive definite (alpha=1.00e+00)
2025-04-27 05:02:04,871 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 05:02:06,411 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 05:02:07,859 - INFO -   Regularizing factor (try 3, alpha=1.00e-03)
2025-04-27 05:02:09,349 - INFO -   Regularizing factor (try 4, alpha=1.00e-02)
2025-04-27 05:02:10,799 - INFO -   Regularizing factor (try 5, alpha=1.00e-01)
2025-04-27 05:02:12,456 - INFO -   Factor is positive definite (alpha=1.00e+00)
model.layers.29.self_attn.o_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_self_attn_o_proj.safetensors True
Layer: model.layers.29.self_attn.o_proj | Ratio: 0.200 -> Target Rank: 416 (Align: 8)
layer module Linear(in_features=4096, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Regularizing factor (try 3, alpha=1.00e-03)
  Regularizing factor (try 4, alpha=1.00e-02)
  Regularizing factor (try 5, alpha=1.00e-01)
  Factor is positive definite (alpha=1.00e+00)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x4096)...
  SVD complete. Singular values (top 5): [6.7981046e-06 4.0892810e-06 4.0308264e-06 3.7138766e-06 3.4338238e-06]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (416,4096), (4096,416)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)
2025-04-27 05:02:55,301 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=416, bias=False)
  (1): Linear(in_features=416, out_features=4096, bias=False)
)')
2025-04-27 05:02:55,301 - INFO - Replacing 'model.layers.29.self_attn.o_proj' (attribute 'o_proj' within parent LlamaAttention)
2025-04-27 05:02:55,304 - INFO - Compression finished. 
2025-04-27 05:03:09,489 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:13,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:13<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 05:03:39,399 - INFO - wikitext2 perplexity: 7.0000
2025-04-27 05:03:39,399 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.9453125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.21s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 05:04:33,544 - INFO - ptb perplexity: 25.7500
2025-04-27 05:04:33,544 - INFO - Evaluation results:
2025-04-27 05:04:33,544 - INFO -   wikitext2: 7.0000
2025-04-27 05:04:33,544 - INFO -   ptb: 25.7500
nlls.shape torch.Size([16376])
Mean NLL: 3.25
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:12<00:25, 12.56s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:25<00:13, 13.00s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:34<00:00, 11.22s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:34<00:00, 11.65s/it]
2025-04-27 05:05:08,896 - INFO - Layer: model.layers.29.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 05:05:08,899 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_mlp_gate_proj.safetensors
2025-04-27 05:05:08,899 - INFO - exists: True
2025-04-27 05:05:08,904 - INFO - factorize_layer_kron_svd
2025-04-27 05:05:10,811 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 05:05:12,431 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 05:05:14,135 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 05:05:16,516 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 05:05:21,485 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.29.mlp.gate_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_mlp_gate_proj.safetensors True
Layer: model.layers.29.mlp.gate_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [4.2779949e-03 5.4828401e-05 2.5178630e-05 1.7353015e-05 1.1980547e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 05:06:43,753 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 05:06:43,753 - INFO - Replacing 'model.layers.29.mlp.gate_proj' (attribute 'gate_proj' within parent LlamaMLP)
2025-04-27 05:06:43,761 - INFO - Compression finished. 
2025-04-27 05:06:58,604 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:24,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.19s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 05:07:28,871 - INFO - wikitext2 perplexity: 7.2812
2025-04-27 05:07:28,871 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.984375
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.17s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 05:07:38,676 - INFO - ptb perplexity: 26.6250
2025-04-27 05:07:38,677 - INFO - Evaluation results:
2025-04-27 05:07:38,677 - INFO -   wikitext2: 7.2812
2025-04-27 05:07:38,677 - INFO -   ptb: 26.6250
nlls.shape torch.Size([16376])
Mean NLL: 3.28125
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.20s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.02s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.33s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.80s/it]
2025-04-27 05:08:14,499 - INFO - Layer: model.layers.29.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 05:08:14,502 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_mlp_up_proj.safetensors
2025-04-27 05:08:14,502 - INFO - exists: True
2025-04-27 05:08:14,537 - INFO - factorize_layer_kron_svd
2025-04-27 05:08:16,361 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 05:08:18,010 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 05:08:19,940 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 05:08:22,296 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 05:08:27,017 - INFO -   Factor is positive definite (alpha=1.00e-04)
model.layers.29.mlp.up_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_mlp_up_proj.safetensors True
Layer: model.layers.29.mlp.up_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=4096, out_features=11008, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Factor is positive definite (alpha=1.00e-04)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (11008x4096)...
  SVD complete. Singular values (top 5): [2.5008040e-02 2.4909425e-05 1.7541013e-05 1.1958569e-05 1.1578863e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,4096), (11008,600)
factorized_sequential Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)
2025-04-27 05:09:52,942 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=4096, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=11008, bias=False)
)')
2025-04-27 05:09:52,942 - INFO - Replacing 'model.layers.29.mlp.up_proj' (attribute 'up_proj' within parent LlamaMLP)
2025-04-27 05:09:52,950 - INFO - Compression finished. 
2025-04-27 05:10:06,012 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.20s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 05:10:35,796 - INFO - wikitext2 perplexity: 7.6250
2025-04-27 05:10:35,796 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 2.03125
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.20s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.19s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.19s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.17s/it]
2025-04-27 05:10:45,735 - INFO - ptb perplexity: 28.3750
2025-04-27 05:10:45,735 - INFO - Evaluation results:
2025-04-27 05:10:45,735 - INFO -   wikitext2: 7.6250
2025-04-27 05:10:45,735 - INFO -   ptb: 28.3750
nlls.shape torch.Size([16376])
Mean NLL: 3.34375
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:27, 13.52s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.43s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 11.72s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:36<00:00, 12.19s/it]
2025-04-27 05:11:22,953 - INFO - Layer: model.layers.29.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
2025-04-27 05:11:22,958 - INFO - factor_filename: /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_mlp_down_proj.safetensors
2025-04-27 05:11:22,958 - INFO - exists: True
2025-04-27 05:11:22,981 - INFO - factorize_layer_kron_svd
2025-04-27 05:11:25,628 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 05:11:29,503 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 05:11:34,323 - INFO -   Factor is positive definite (alpha=1.00e-03)
2025-04-27 05:11:35,793 - INFO -   Regularizing factor (try 1, alpha=1.00e-05)
2025-04-27 05:11:37,546 - INFO -   Regularizing factor (try 2, alpha=1.00e-04)
2025-04-27 05:11:39,264 - INFO -   Factor is positive definite (alpha=1.00e-03)
model.layers.29.mlp.down_proj
factor_filename /home/jovyan/shares/SR004.nfs2/chekalina/FisherKronecker/grads_output/llama-2-7b-chat/fisher_factors_output_1404/model_layers_29_mlp_down_proj.safetensors True
Layer: model.layers.29.mlp.down_proj | Ratio: 0.200 -> Target Rank: 600 (Align: 8)
layer module Linear(in_features=11008, out_features=4096, bias=False)
factorize_layer_kron_svd
Regularizing factors for layer (initial alpha=1.00e-05)...
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Regularizing factor (try 1, alpha=1.00e-05)
  Regularizing factor (try 2, alpha=1.00e-04)
  Factor is positive definite (alpha=1.00e-03)
  Cholesky decomposition successful.
  Performing SVD on transformed matrix (4096x11008)...
  SVD complete. Singular values (top 5): [8.4675699e-02 1.7794147e-04 6.2655701e-05 4.7701098e-05 4.6559559e-05]
  Cholesky factor inverses computed.
  Factorization complete for layer. New shapes: (600,11008), (4096,600)
factorized_sequential Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)
2025-04-27 05:13:26,680 - INFO - factorized_sequential 'Sequential(
  (0): Linear(in_features=11008, out_features=600, bias=False)
  (1): Linear(in_features=600, out_features=4096, bias=False)
)')
2025-04-27 05:13:26,681 - INFO - Replacing 'model.layers.29.mlp.down_proj' (attribute 'down_proj' within parent LlamaMLP)
2025-04-27 05:13:26,688 - INFO - Compression finished. 
2025-04-27 05:13:34,541 - INFO - Evaluating on wikitext2
Evaluating:   0%|                                                                      | 0/21 [00:00<?, ?it/s]Evaluating:   5%|██▉                                                           | 1/21 [00:01<00:23,  1.19s/it]Evaluating:  10%|█████▉                                                        | 2/21 [00:02<00:22,  1.18s/it]Evaluating:  14%|████████▊                                                     | 3/21 [00:03<00:21,  1.18s/it]Evaluating:  19%|███████████▊                                                  | 4/21 [00:04<00:20,  1.18s/it]Evaluating:  24%|██████████████▊                                               | 5/21 [00:05<00:18,  1.18s/it]Evaluating:  29%|█████████████████▋                                            | 6/21 [00:07<00:17,  1.18s/it]Evaluating:  33%|████████████████████▋                                         | 7/21 [00:08<00:16,  1.18s/it]Evaluating:  38%|███████████████████████▌                                      | 8/21 [00:09<00:15,  1.18s/it]Evaluating:  43%|██████████████████████████▌                                   | 9/21 [00:10<00:14,  1.18s/it]Evaluating:  48%|█████████████████████████████                                | 10/21 [00:11<00:12,  1.18s/it]Evaluating:  52%|███████████████████████████████▉                             | 11/21 [00:12<00:11,  1.18s/it]Evaluating:  57%|██████████████████████████████████▊                          | 12/21 [00:14<00:10,  1.18s/it]Evaluating:  62%|█████████████████████████████████████▊                       | 13/21 [00:15<00:09,  1.18s/it]Evaluating:  67%|████████████████████████████████████████▋                    | 14/21 [00:16<00:08,  1.18s/it]Evaluating:  71%|███████████████████████████████████████████▌                 | 15/21 [00:17<00:07,  1.18s/it]Evaluating:  76%|██████████████████████████████████████████████▍              | 16/21 [00:18<00:05,  1.18s/it]Evaluating:  81%|█████████████████████████████████████████████████▍           | 17/21 [00:20<00:04,  1.18s/it]Evaluating:  86%|████████████████████████████████████████████████████▎        | 18/21 [00:21<00:03,  1.18s/it]Evaluating:  90%|███████████████████████████████████████████████████████▏     | 19/21 [00:22<00:02,  1.18s/it]Evaluating:  95%|██████████████████████████████████████████████████████████   | 20/21 [00:23<00:01,  1.18s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.10s/it]Evaluating: 100%|█████████████████████████████████████████████████████████████| 21/21 [00:24<00:00,  1.17s/it]
2025-04-27 05:14:04,392 - INFO - wikitext2 perplexity: 7.1562
2025-04-27 05:14:04,393 - INFO - Evaluating on ptb
nlls.shape torch.Size([16376])
Mean NLL: 1.96875
Evaluating:   0%|                                                                       | 0/7 [00:00<?, ?it/s]Evaluating:  14%|█████████                                                      | 1/7 [00:01<00:07,  1.17s/it]Evaluating:  29%|██████████████████                                             | 2/7 [00:02<00:05,  1.18s/it]Evaluating:  43%|███████████████████████████                                    | 3/7 [00:03<00:04,  1.18s/it]Evaluating:  57%|████████████████████████████████████                           | 4/7 [00:04<00:03,  1.18s/it]Evaluating:  71%|█████████████████████████████████████████████                  | 5/7 [00:05<00:02,  1.18s/it]Evaluating:  86%|██████████████████████████████████████████████████████         | 6/7 [00:07<00:01,  1.18s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.14s/it]Evaluating: 100%|███████████████████████████████████████████████████████████████| 7/7 [00:08<00:00,  1.16s/it]
2025-04-27 05:14:14,242 - INFO - ptb perplexity: 26.2500
2025-04-27 05:14:14,243 - INFO - Evaluation results:
2025-04-27 05:14:14,243 - INFO -   wikitext2: 7.1562
2025-04-27 05:14:14,243 - INFO -   ptb: 26.2500
nlls.shape torch.Size([16376])
Mean NLL: 3.265625
Loading checkpoint shards:   0%|                                                        | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|████████████████                                | 1/3 [00:13<00:26, 13.21s/it]Loading checkpoint shards:  67%|████████████████████████████████                | 2/3 [00:26<00:13, 13.29s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.45s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████| 3/3 [00:35<00:00, 11.94s/it]



dct
{'model.layers.21.self_attn.q_proj': [6.9375, 25.75], 'model.layers.21.self_attn.k_proj': [6.9375, 25.75], 'model.layers.21.self_attn.v_proj': [6.9375, 25.75], 'model.layers.21.self_attn.o_proj': [7.0, 25.75], 'model.layers.21.mlp.gate_proj': [7.0625, 25.75], 'model.layers.21.mlp.up_proj': [7.0625, 25.75], 'model.layers.21.mlp.down_proj': [7.09375, 25.75], 'model.layers.22.self_attn.q_proj': [6.9375, 25.75], 'model.layers.22.self_attn.k_proj': [6.9375, 25.75], 'model.layers.22.self_attn.v_proj': [6.9375, 25.75], 'model.layers.22.self_attn.o_proj': [7.0, 25.75], 'model.layers.22.mlp.gate_proj': [7.0, 25.75], 'model.layers.22.mlp.up_proj': [7.0625, 25.375], 'model.layers.22.mlp.down_proj': [7.09375, 25.75], 'model.layers.23.self_attn.q_proj': [6.9375, 25.75], 'model.layers.23.self_attn.k_proj': [6.9375, 25.75], 'model.layers.23.self_attn.v_proj': [6.9375, 25.75], 'model.layers.23.self_attn.o_proj': [7.0, 25.75], 'model.layers.23.mlp.gate_proj': [7.0625, 25.75], 'model.layers.23.mlp.up_proj': [7.0625, 25.75], 'model.layers.23.mlp.down_proj': [7.0625, 25.75], 'model.layers.24.self_attn.q_proj': [6.9375, 25.75], 'model.layers.24.self_attn.k_proj': [6.9375, 25.75], 'model.layers.24.self_attn.v_proj': [6.9375, 25.75], 'model.layers.24.self_attn.o_proj': [7.0, 26.25], 'model.layers.24.mlp.gate_proj': [7.0625, 25.75], 'model.layers.24.mlp.up_proj': [7.0625, 25.75], 'model.layers.24.mlp.down_proj': [7.09375, 25.75], 'model.layers.25.self_attn.q_proj': [7.0, 25.75], 'model.layers.25.self_attn.k_proj': [7.0, 25.75], 'model.layers.25.self_attn.v_proj': [7.0, 25.75], 'model.layers.25.self_attn.o_proj': [7.0, 25.75], 'model.layers.25.mlp.gate_proj': [7.0625, 25.75], 'model.layers.25.mlp.up_proj': [7.0625, 25.75], 'model.layers.25.mlp.down_proj': [7.0625, 25.75], 'model.layers.26.self_attn.q_proj': [7.0, 25.75], 'model.layers.26.self_attn.k_proj': [7.0, 25.75], 'model.layers.26.self_attn.v_proj': [6.9375, 25.375], 'model.layers.26.self_attn.o_proj': [6.9375, 25.375], 'model.layers.26.mlp.gate_proj': [7.0625, 26.25], 'model.layers.26.mlp.up_proj': [7.09375, 25.75], 'model.layers.26.mlp.down_proj': [7.0625, 25.75], 'model.layers.27.self_attn.q_proj': [6.9375, 25.375], 'model.layers.27.self_attn.k_proj': [6.9375, 25.375], 'model.layers.27.self_attn.v_proj': [6.9375, 25.75], 'model.layers.27.self_attn.o_proj': [6.9375, 25.75], 'model.layers.27.mlp.gate_proj': [7.09375, 26.25], 'model.layers.27.mlp.up_proj': [7.15625, 26.25], 'model.layers.27.mlp.down_proj': [7.0625, 26.25], 'model.layers.28.self_attn.q_proj': [6.84375, 25.375], 'model.layers.28.self_attn.k_proj': [6.78125, 25.0], 'model.layers.28.self_attn.v_proj': [7.0, 25.75], 'model.layers.28.self_attn.o_proj': [7.0, 25.75], 'model.layers.28.mlp.gate_proj': [7.21875, 26.25], 'model.layers.28.mlp.up_proj': [7.375, 26.625], 'model.layers.28.mlp.down_proj': [7.375, 26.25], 'model.layers.29.self_attn.q_proj': [6.9375, 25.75], 'model.layers.29.self_attn.k_proj': [6.9375, 25.75], 'model.layers.29.self_attn.v_proj': [7.0, 25.75], 'model.layers.29.self_attn.o_proj': [7.0, 25.75], 'model.layers.29.mlp.gate_proj': [7.28125, 26.625], 'model.layers.29.mlp.up_proj': [7.625, 28.375], 'model.layers.29.mlp.down_proj': [7.15625, 26.25]}
